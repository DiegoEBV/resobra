import{c as Oe}from"./chunk-KP3O5NWI.js";import{a as be}from"./chunk-ZRWZICCZ.js";import{h as Ee}from"./chunk-HTLDYV3H.js";import{a as he,b as xe}from"./chunk-NDUK2CYE.js";import{a as ye}from"./chunk-KHAWAD67.js";import{d as fe}from"./chunk-LUBQLQMY.js";import{a as we,b as Pe}from"./chunk-UOQIYJR2.js";import{a as ue,b as _e}from"./chunk-VL2NEHIJ.js";import{a as pe,b as me}from"./chunk-7ORSVDA5.js";import{a as G,c as H}from"./chunk-NB3HFZVT.js";import{a as q,b as Z,c as J,d as K,f as Y,h as ee}from"./chunk-Q7IKAR2H.js";import"./chunk-F5X5MWHG.js";import{a as Ce,b as Ie}from"./chunk-TXLZEOAT.js";import"./chunk-ZBAF6PQQ.js";import{a as Me}from"./chunk-EBI2TTL3.js";import"./chunk-4SALBWPR.js";import"./chunk-SGFNFZY3.js";import{a as ge,b as ve}from"./chunk-ZJYJPMQY.js";import{b as ae,c as oe}from"./chunk-5ME2OED7.js";import{F as ie,G as ne,w as W,y as te}from"./chunk-GGGSXGOB.js";import{h as R,i as $,j as L,m as j,n as Q,p as X,pa as re,ra as se,sa as de,ta as ce,ua as le}from"./chunk-MD4YSZKI.js";import{Bc as U,Cb as N,Db as c,Eb as D,Fb as A,Mb as a,Nb as n,Ob as M,Sb as I,Wb as u,X as S,Xb as l,bb as k,db as r,f as F,fc as B,gc as s,hc as x,ib as b,ic as f,jc as T,o as z,pa as g,pb as V,qa as v,tc as E,uc as y,vb as _,vc as O}from"./chunk-OYRL5FJJ.js";import"./chunk-X5YLR3NI.js";import{i as h}from"./chunk-ODN5LVDJ.js";function Se(o,p){o&1&&(a(0,"div",6)(1,"mat-card")(2,"mat-card-content")(3,"p"),s(4,"Cargando actividad..."),n()()()())}function ke(o,p){if(o&1&&(a(0,"div",12)(1,"mat-icon"),s(2,"event"),n(),a(3,"span"),s(4),E(5,"date"),n()()),o&2){let e=l(2);r(4),x(O(5,1,e.actividad.fecha,"dd/MM/yyyy"))}}function De(o,p){if(o&1&&(a(0,"div",37)(1,"mat-icon"),s(2,"info"),n(),a(3,"p"),s(4,"No hay tareas definidas para esta actividad"),n(),a(5,"p",38),s(6),n()()),o&2){let e=l(3);r(6),f("Actividad ID: ",e.actividadId,"")}}function Ae(o,p){if(o&1&&(a(0,"p",47),s(1),n()),o&2){let e=l().$implicit;r(),f(" ",e.descripcion," ")}}function Te(o,p){if(o&1&&(a(0,"div",48)(1,"mat-icon"),s(2,"check_circle"),n(),a(3,"span"),s(4),E(5,"date"),n()()),o&2){let e=l().$implicit;r(4),f("Completada el ",O(5,1,e.fecha_completado,"dd/MM/yyyy HH:mm"),"")}}function Fe(o,p){if(o&1){let e=I();a(0,"div",39)(1,"mat-checkbox",40),u("change",function(){let t=g(e).$implicit,d=l(3);return v(d.toggleTareaCompletada(t))}),n(),a(2,"div",41)(3,"div",42)(4,"span",43),s(5),n(),a(6,"span",44),s(7),n()(),_(8,Ae,2,1,"p",45)(9,Te,6,4,"div",46),n()()}if(o&2){let e=p.$implicit;r(),c("checked",e.completada)("color","primary"),r(3),A("completed",e.completada),r(),f(" ",e.nombre," "),r(2),f("#",e.orden,""),r(),c("ngIf",e.descripcion),r(),c("ngIf",e.fecha_completado)}}function ze(o,p){if(o&1){let e=I();a(0,"div",32)(1,"div",33)(2,"h3"),s(3,"Tareas y Progreso"),n(),a(4,"button",34),u("click",function(){g(e);let t=l(2);return v(t.refreshTareas())}),a(5,"mat-icon"),s(6,"refresh"),n()()(),_(7,De,7,1,"div",35)(8,Fe,10,8,"div",36),n()}if(o&2){let e=l(2);r(7),c("ngIf",e.tareas.length===0),r(),c("ngForOf",e.tareas)}}function Ve(o,p){o&1&&(a(0,"div",49)(1,"p"),s(2,"Cargando tareas..."),n()())}function Ne(o,p){if(o&1&&M(0,"mat-progress-bar",73),o&2){let e=l().$implicit;c("value",e.progress)}}function Be(o,p){if(o&1&&(a(0,"div",74)(1,"small"),s(2),n()()),o&2){let e=l().$implicit;r(2),x(e.error)}}function Ue(o,p){if(o&1){let e=I();a(0,"button",75),u("click",function(){g(e);let t=l().$implicit,d=l(3);return v(d.removePreviewImage(t.id))}),a(1,"mat-icon"),s(2,"close"),n()()}}function Re(o,p){if(o&1){let e=I();a(0,"button",76),u("click",function(){g(e);let t=l().$implicit,d=l(3);return v(d.retryUpload(t.id))}),a(1,"mat-icon"),s(2,"refresh"),n()()}}function $e(o,p){if(o&1){let e=I();a(0,"button",77),u("click",function(){g(e);let t=l().$implicit,d=l(3);return v(d.uploadSingleImage(t.id))}),a(1,"mat-icon"),s(2,"upload"),n()()}}function Le(o,p){if(o&1){let e=I();a(0,"mat-form-field",78)(1,"mat-label"),s(2,"Descripci\xF3n (opcional)"),n(),a(3,"input",79),u("input",function(t){g(e);let d=l().$implicit,m=l(3);return v(m.updatePreviewDescription(d.id,t.target.value))}),n()()}if(o&2){let e=l().$implicit;r(3),c("value",e.descripcion||"")("disabled",e.status==="uploading")}}function je(o,p){if(o&1&&(a(0,"div",56)(1,"div",57),M(2,"img",58),a(3,"div",59)(4,"div",60)(5,"mat-icon"),s(6),n(),a(7,"span",61),s(8),n()(),_(9,Ne,1,1,"mat-progress-bar",62)(10,Be,3,1,"div",63),n(),a(11,"div",64),_(12,Ue,3,0,"button",65)(13,Re,3,0,"button",66)(14,$e,3,0,"button",67),n()(),a(15,"div",68)(16,"div",69)(17,"span",70),s(18),n(),a(19,"span",71),s(20),n()(),_(21,Le,4,2,"mat-form-field",72),n()()),o&2){let e=p.$implicit,i=l(3);N("data-status",e.status),r(2),c("src",e.url,k)("alt",e.file.name),r(),c("ngClass","status-"+e.status),r(2),D("color",i.getStatusColor(e.status)),r(),x(i.getStatusIcon(e.status)),r(2),x(i.getStatusText(e.status)),r(),c("ngIf",e.status==="uploading"&&e.progress!==void 0),r(),c("ngIf",e.status==="error"&&e.error),r(2),c("ngIf",e.status==="pending"||e.status==="error"),r(),c("ngIf",e.status==="error"),r(),c("ngIf",e.status==="pending"),r(4),x(e.file.name),r(2),f("(",(e.file.size/1024/1024).toFixed(2)," MB)"),r(),c("ngIf",e.status!=="success")}}function Qe(o,p){o&1&&M(0,"mat-spinner",80)}function Xe(o,p){o&1&&(a(0,"mat-icon"),s(1,"upload"),n())}function Ge(o,p){if(o&1){let e=I();a(0,"div",50)(1,"h4"),s(2),n(),a(3,"div",51),_(4,je,22,16,"div",52),n(),a(5,"div",53)(6,"button",27),u("click",function(){g(e);let t=l(2);return v(t.uploadFiles())}),_(7,Qe,1,0,"mat-spinner",54)(8,Xe,2,0,"mat-icon",5),s(9),n(),a(10,"button",55),u("click",function(){g(e);let t=l(2);return v(t.clearAllPreviews())}),a(11,"mat-icon"),s(12,"clear_all"),n(),s(13," Limpiar Todo "),n()()()}if(o&2){let e=l(2);r(2),T("Im\xE1genes seleccionadas (",e.previewImages.length,"/",e.maxFiles,"):"),r(2),c("ngForOf",e.previewImages),r(2),c("disabled",e.uploadingFile||!e.hasPendingImages()),r(),c("ngIf",e.uploadingFile),r(),c("ngIf",!e.uploadingFile),r(),f(" ",e.uploadingFile?"Subiendo...":"Subir Todas ("+e.getPendingCount()+")"," "),r(),c("disabled",e.uploadingFile)}}function He(o,p){o&1&&M(0,"mat-divider")}function We(o,p){if(o&1){let e=I();a(0,"div",84)(1,"div",85),M(2,"img",86),a(3,"div",87)(4,"button",88),u("click",function(){let t=g(e).$implicit,d=l(3);return v(d.eliminarEvidencia(t))}),a(5,"mat-icon"),s(6,"delete"),n()()()(),a(7,"div",89)(8,"mat-form-field",78)(9,"mat-label"),s(10,"Descripci\xF3n"),n(),a(11,"input",90),u("blur",function(t){let d=g(e).$implicit,m=l(3);return v(m.actualizarDescripcion(d,t.target.value))}),n()(),a(12,"div",91)(13,"small",92)(14,"mat-icon"),s(15,"schedule"),n(),s(16),E(17,"date"),n()()()()}if(o&2){let e=p.$implicit;r(2),c("src",e.url_imagen,k)("alt",e.descripcion||"Evidencia fotogr\xE1fica"),r(9),c("value",e.descripcion||""),r(5),f(" ",O(17,4,e.fecha_subida,"dd/MM/yyyy HH:mm")," ")}}function qe(o,p){if(o&1&&(a(0,"div",81)(1,"h4"),s(2,"Evidencias Subidas:"),n(),a(3,"div",82),_(4,We,18,7,"div",83),n()()),o&2){let e=l(2);r(4),c("ngForOf",e.evidencias)}}function Ze(o,p){o&1&&(a(0,"div",93),M(1,"mat-spinner",94),a(2,"p"),s(3,"Cargando evidencias..."),n()())}function Je(o,p){o&1&&(a(0,"div",95)(1,"mat-icon"),s(2,"photo_library"),n(),a(3,"p"),s(4,"No hay evidencias fotogr\xE1ficas subidas"),n(),a(5,"p",96),s(6,"Sube fotos para documentar el progreso de esta actividad"),n()())}function Ke(o,p){if(o&1){let e=I();a(0,"div")(1,"mat-card",7)(2,"mat-card-header")(3,"mat-card-title"),s(4),E(5,"titlecase"),n(),a(6,"mat-card-subtitle")(7,"span",8),s(8),E(9,"titlecase"),n()()(),a(10,"mat-card-content")(11,"p",9),s(12),n(),a(13,"div",10)(14,"div",11)(15,"div",12)(16,"mat-icon"),s(17,"category"),n(),a(18,"span"),s(19),n()(),a(20,"div",12)(21,"mat-icon"),s(22,"flag"),n(),a(23,"span"),s(24),E(25,"titlecase"),n()()(),a(26,"div",11)(27,"div",12)(28,"mat-icon"),s(29,"person"),n(),a(30,"span"),s(31),n()(),_(32,ke,6,4,"div",13),n()()()(),a(33,"mat-card",14)(34,"mat-card-header")(35,"mat-card-title")(36,"mat-icon"),s(37,"assignment"),n(),s(38," Tareas y Progreso "),n(),a(39,"mat-card-subtitle"),s(40),n()(),a(41,"mat-card-content")(42,"div",15)(43,"div",16)(44,"span",17),s(45,"Progreso General"),n(),a(46,"span",18),s(47),n()(),M(48,"mat-progress-bar",19),n(),M(49,"mat-divider"),_(50,ze,9,2,"div",20)(51,Ve,3,0,"div",21),n()(),a(52,"mat-card",22)(53,"mat-card-header")(54,"mat-card-title")(55,"mat-icon"),s(56,"photo_camera"),n(),s(57," Evidencia Fotogr\xE1fica "),n(),a(58,"mat-card-subtitle"),s(59),n()(),a(60,"mat-card-content")(61,"div",23),u("dragover",function(t){g(e);let d=l();return v(d.onDragOver(t))})("dragleave",function(t){g(e);let d=l();return v(d.onDragLeave(t))})("drop",function(t){g(e);let d=l();return v(d.onDrop(t))}),a(62,"div",24)(63,"mat-icon",25),s(64,"cloud_upload"),n(),a(65,"p"),s(66,"Arrastra las im\xE1genes aqu\xED o haz clic para seleccionar"),n(),a(67,"input",26,0),u("change",function(t){g(e);let d=l();return v(d.onFileSelected(t))}),n(),a(69,"button",27),u("click",function(){g(e);let t=B(68);return v(t.click())}),a(70,"mat-icon"),s(71,"add_photo_alternate"),n(),s(72," Seleccionar Fotos "),n()()(),_(73,Ge,14,8,"div",28)(74,He,1,0,"mat-divider",5)(75,qe,5,1,"div",29)(76,Ze,4,0,"div",30)(77,Je,7,0,"div",31),n()()()}if(o&2){let e=l();r(4),x(y(5,25,e.actividad.tipo_actividad)),r(3),D("background-color",e.getEstadoColor(e.actividad.estado)),r(),f(" ",y(9,27,e.actividad.estado)," "),r(4),x(e.actividad.observaciones),r(7),x(e.actividad.tipo_actividad),r(5),x(y(25,29,e.actividad.tipo_actividad)),r(7),x(e.actividad.responsable),r(),c("ngIf",e.actividad.fecha),r(8),T(" ",e.tareas.length," tarea(s) - ",e.progreso,"% completado "),r(7),f("",e.progreso,"%"),r(),c("value",e.progreso)("color",e.getProgresoColor()),r(2),c("ngIf",!e.loadingTareas),r(),c("ngIf",e.loadingTareas),r(8),f(" ",e.evidencias.length," foto(s) subida(s) "),r(2),A("drag-over",e.dragOver),r(8),c("disabled",e.uploadingFile),r(4),c("ngIf",e.previewImages.length>0),r(),c("ngIf",e.selectedFiles.length>0),r(),c("ngIf",!e.loadingEvidencias&&e.evidencias.length>0),r(),c("ngIf",e.loadingEvidencias),r(),c("ngIf",!e.loadingEvidencias&&e.evidencias.length===0)}}var Ft=(()=>{class o{constructor(e,i,t,d,m,C,w){this.route=e,this.router=i,this.actividadesService=t,this.evidenciaService=d,this.tareasService=m,this.snackBar=C,this.cdr=w,this.destroy$=new F,this.actividadId=null,this.actividad=null,this.tareas=[],this.progreso=0,this.loading=!0,this.loadingTareas=!1,this.evidencias=[],this.loadingEvidencias=!1,this.uploadingFile=!1,this.selectedFiles=[],this.dragOver=!1,this.previewImages=[],this.uploadProgress={},this.maxFiles=10,this.MAX_CONCURRENT_UPLOADS=2,this.currentUploads=0,this.uploadQueue=[],this.uploadLock=!1,this.actividadId=this.route.snapshot.paramMap.get("id")}ngOnInit(){this.route.params.pipe(S(this.destroy$)).subscribe(e=>{this.actividadId=e.id,console.log("\u{1F50D} [DetalleActividad] ID de actividad obtenido:",this.actividadId),this.actividadId&&(this.loadActividad(),setTimeout(()=>{this.loadTareas(),this.loadEvidencias()},100),this.subscribeToProgresoUpdates())})}ngOnDestroy(){this.destroy$.next(),this.destroy$.complete()}subscribeToProgresoUpdates(){this.actividadesService.progresoUpdated$.pipe(S(this.destroy$)).subscribe(({actividadId:e,progreso:i})=>{e===this.actividadId&&this.actividad&&(this.actividad.progreso_porcentaje=i,this.progreso=i)})}loadActividad(){return h(this,null,function*(){try{if(this.loading=!0,this.actividad=yield this.actividadesService.getActividadById(this.actividadId),!this.actividad){this.snackBar.open("Actividad no encontrada","Cerrar",{duration:3e3}),this.router.navigate(["/actividades"]);return}}catch(e){console.error("Error cargando actividad:",e),this.snackBar.open("Error cargando actividad","Cerrar",{duration:3e3})}finally{this.loading=!1}})}loadTareas(){return h(this,null,function*(){try{if(this.loadingTareas=!0,console.log("\u{1F50D} [DetalleActividad] Cargando tareas para actividad ID:",this.actividadId),!this.actividadId){console.error("\u274C [DetalleActividad] No hay actividadId disponible");return}this.tareas=yield this.actividadesService.getTareasByActividad(this.actividadId),console.log("\u{1F4CB} [DetalleActividad] Tareas obtenidas:",this.tareas.length,this.tareas),this.calcularProgreso()}catch(e){console.error("\u274C [DetalleActividad] Error cargando tareas:",e),this.snackBar.open("Error cargando tareas","Cerrar",{duration:3e3})}finally{this.loadingTareas=!1}})}calcularProgreso(){if(this.tareas.length===0){this.progreso=0;return}let e=this.tareas.filter(i=>i.completada).length;this.progreso=Math.round(e/this.tareas.length*100)}toggleTareaCompletada(e){return h(this,null,function*(){let i=e.completada,t=!e.completada;e.completada=t,t?e.fecha_completado=new Date().toISOString():e.fecha_completado=void 0,this.calcularProgreso();try{yield this.actividadesService.updateTareaEstado(e.id,t);let d=t?"Tarea marcada como completada":"Tarea marcada como pendiente";this.snackBar.open(d,"Cerrar",{duration:2e3})}catch(d){e.completada=i,i?e.fecha_completado=new Date().toISOString():e.fecha_completado=void 0,this.calcularProgreso(),console.error("Error actualizando tarea:",d),this.snackBar.open("Error actualizando tarea","Cerrar",{duration:3e3})}})}getEstadoColor(e){return{programado:"#2196F3",ejecucion:"#FF9800",finalizado:"#4CAF50",pausado:"#9E9E9E",cancelado:"#F44336"}[e]||"#9E9E9E"}getProgresoColor(){return this.progreso===100?"primary":this.progreso>=50?"accent":"warn"}refreshTareas(){return h(this,null,function*(){console.log("\u{1F504} [DetalleActividad] Refrescando tareas manualmente"),yield this.loadTareas()})}loadEvidencias(){return h(this,null,function*(){if(!this.actividadId){console.warn("\u274C No se puede cargar evidencias: actividadId no definido");return}try{this.loadingEvidencias=!0,console.log("\u{1F504} INICIANDO CARGA DE EVIDENCIAS",{actividadId:this.actividadId,timestamp:new Date().toISOString()});let e=yield z(this.evidenciaService.obtenerEvidenciasPorActividad(this.actividadId));e?(this.evidencias=e,console.log("\u2705 EVIDENCIAS CARGADAS EXITOSAMENTE",{actividadId:this.actividadId,cantidadEvidencias:e.length,evidenciasIds:e.map(i=>i.id),timestamp:new Date().toISOString()}),e.forEach((i,t)=>{console.log(`\u{1F4F8} Evidencia ${t+1}:`,{id:i.id,nombre_archivo:i.nombre_archivo,url_imagen:i.url_imagen,descripcion:i.descripcion,fecha_subida:i.fecha_subida,subido_por:i.subido_por})})):(this.evidencias=[],console.log("\u2139\uFE0F NO SE ENCONTRARON EVIDENCIAS",{actividadId:this.actividadId,timestamp:new Date().toISOString()}))}catch(e){console.error("\u274C ERROR CARGANDO EVIDENCIAS",{actividadId:this.actividadId,errorName:e.name,errorMessage:e.message,errorStack:e.stack,timestamp:new Date().toISOString()}),this.evidencias=[],this.snackBar.open("Error cargando evidencias fotogr\xE1ficas","Cerrar",{duration:3e3})}finally{this.loadingEvidencias=!1,console.log("\u{1F3C1} CARGA DE EVIDENCIAS FINALIZADA",{actividadId:this.actividadId,cantidadFinal:this.evidencias.length,timestamp:new Date().toISOString()})}})}onDragOver(e){e.preventDefault(),this.dragOver=!0}onDragLeave(e){e.preventDefault(),this.dragOver=!1}onDrop(e){e.preventDefault(),this.dragOver=!1;let i=Array.from(e.dataTransfer?.files||[]);this.handleFiles(i)}onFileSelected(e){let i=e.target.files;i&&i.length>0&&this.handleFiles(Array.from(i))}handleFiles(e){if(console.log("\u{1F4C1} Procesando archivos:",e.length),this.previewImages.length+e.length>this.maxFiles){this.snackBar.open(`M\xE1ximo ${this.maxFiles} archivos permitidos`,"Cerrar",{duration:3e3});return}let t=e.filter(d=>{let m=d.type.startsWith("image/"),C=d.size<=5*1024*1024;return m?C?!0:(this.snackBar.open(`${d.name} es muy grande (m\xE1ximo 5MB)`,"Cerrar",{duration:3e3}),!1):(this.snackBar.open(`${d.name} no es una imagen v\xE1lida`,"Cerrar",{duration:3e3}),!1)});console.log("\u2705 Archivos v\xE1lidos:",t.length),t.forEach(d=>{let m=new FileReader,C=this.generateId();console.log("\u{1F4D6} Leyendo archivo:",d.name,"ID:",C),m.onload=w=>{let P={id:C,file:d,url:w.target?.result,status:"pending",descripcion:""};console.log("\u{1F4F7} Imagen cargada:",d.name,"URL length:",P.url.length),this.previewImages.push(P),this.cdr.detectChanges(),console.log("\u{1F504} Vista actualizada. Total im\xE1genes:",this.previewImages.length)},m.onerror=w=>{console.error("\u274C Error leyendo archivo:",d.name,w),this.snackBar.open(`Error cargando ${d.name}`,"Cerrar",{duration:3e3})},m.readAsDataURL(d)}),this.selectedFiles=[...this.selectedFiles,...t],console.log("\u{1F4CB} Total selectedFiles:",this.selectedFiles.length)}uploadFiles(){return h(this,null,function*(){if(!(!this.actividadId||this.previewImages.length===0||this.uploadLock)){this.uploadingFile=!0,this.uploadLock=!0;try{let e=this.previewImages.filter(t=>t.status==="pending");this.uploadQueue.push(...e),yield this.processUploadQueue(),setTimeout(()=>{this.previewImages=this.previewImages.filter(t=>t.status!=="success"),this.selectedFiles=[]},2e3),yield this.loadEvidencias();let i=e.filter(t=>t.status==="success").length;i>0&&this.snackBar.open(`${i} evidencia(s) subida(s) correctamente`,"Cerrar",{duration:3e3})}finally{this.uploadingFile=!1,this.uploadLock=!1}}})}processUploadQueue(){return h(this,null,function*(){let e=[];for(;this.uploadQueue.length>0&&this.currentUploads<this.MAX_CONCURRENT_UPLOADS;){let i=this.uploadQueue.shift();if(i){this.currentUploads++;let t=this.uploadWithConcurrencyControl(i).finally(()=>{this.currentUploads--});e.push(t)}}e.length>0&&(yield Promise.all(e),this.uploadQueue.length>0&&(yield this.processUploadQueue()))})}uploadWithConcurrencyControl(e){return h(this,null,function*(){try{e.status="uploading",e.progress=0;let i=setInterval(()=>{e.progress<90&&(e.progress+=10)},200),t=this.evidenciaService.subirEvidencia(e.file,this.actividadId,e.descripcion),d=new Promise((m,C)=>{setTimeout(()=>C(new Error("Upload timeout")),3e4)});yield Promise.race([t,d]),clearInterval(i),e.progress=100,e.status="success"}catch(i){console.error("Error subiendo evidencia:",i),e.status="error",e.error=this.getErrorMessage(i)}})}getErrorMessage(e){return e?.message?.includes("timeout")?"Tiempo de espera agotado. Intenta de nuevo.":e?.message?.includes("NavigatorLockAcquireTimeoutError")?"Sistema ocupado. Intenta de nuevo en unos segundos.":e?.message?.includes("Bucket not found")?"Error de configuraci\xF3n. Contacta al administrador.":"Error al subir la imagen. Intenta de nuevo."}removeSelectedFile(e){this.selectedFiles.splice(e,1)}generateId(){return Math.random().toString(36).substr(2,9)}removePreviewImage(e){console.log("\u{1F5D1}\uFE0F Eliminando imagen de previsualizaci\xF3n:",e);let i=this.previewImages.findIndex(t=>t.id===e);if(i>-1){let t=this.previewImages[i];console.log("\u{1F4F7} Imagen encontrada para eliminar:",t.file.name),t.url.startsWith("blob:")&&(URL.revokeObjectURL(t.url),console.log("\u{1F9F9} URL de blob revocada")),this.previewImages.splice(i,1),console.log("\u2705 Imagen eliminada del array previewImages. Total restante:",this.previewImages.length);let d=this.selectedFiles.findIndex(m=>m.name===t.file.name);d>-1&&(this.selectedFiles.splice(d,1),console.log("\u2705 Archivo eliminado del array selectedFiles. Total restante:",this.selectedFiles.length)),this.cdr.detectChanges(),console.log("\u{1F504} Detecci\xF3n de cambios forzada")}else console.warn("\u26A0\uFE0F No se encontr\xF3 la imagen con ID:",e)}updatePreviewDescription(e,i){let t=this.previewImages.find(d=>d.id===e);t&&(t.descripcion=i)}retryUpload(e){let i=this.previewImages.find(t=>t.id===e);i&&i.status==="error"&&(i.status="pending",i.error=void 0,i.progress=0)}uploadSingleImage(e){let i=this.previewImages.find(t=>t.id===e);if(!i||!this.actividadId||this.currentUploads>=this.MAX_CONCURRENT_UPLOADS){this.currentUploads>=this.MAX_CONCURRENT_UPLOADS&&this.snackBar.open("M\xE1ximo de subidas simult\xE1neas alcanzado. Espera un momento.","Cerrar",{duration:3e3});return}this.uploadSinglePreviewImage(i)}uploadSinglePreviewImage(e){return h(this,null,function*(){this.currentUploads++;let i=e.file.name;try{console.log("\u{1F680} INICIANDO SUBIDA INDIVIDUAL",{fileName:i,timestamp:new Date().toISOString()}),e.status="uploading",e.progress=0,console.log("\u{1F4CA} Estado actualizado a uploading",{fileName:i});let t=setInterval(()=>{e.progress<90&&(e.progress+=10)},200);console.log("\u{1F4E4} Llamando al servicio de evidencia",{fileName:i,actividadId:this.actividadId,descripcion:e.descripcion});let d=this.evidenciaService.subirEvidencia(e.file,this.actividadId,e.descripcion),m=new Promise((w,P)=>{setTimeout(()=>P(new Error("Upload timeout")),3e4)}),C=yield Promise.race([d,m]);console.log("\u2705 EVIDENCIA SUBIDA EXITOSAMENTE",{fileName:i,evidenciaId:C?.id,timestamp:new Date().toISOString()}),clearInterval(t),e.progress=100,e.status="success",console.log("\u2705 Estado actualizado a success",{fileName:i}),setTimeout(()=>{this.removePreviewImage(e.id)},2e3),console.log("\u{1F504} Recargando evidencias...",{timestamp:new Date().toISOString()}),yield this.loadEvidencias(),console.log("\u2705 Evidencias recargadas exitosamente",{timestamp:new Date().toISOString()}),this.snackBar.open("Evidencia subida correctamente","Cerrar",{duration:2e3}),console.log("\u{1F514} Notificaci\xF3n de \xE9xito mostrada",{fileName:i})}catch(t){console.error("\u274C ERROR EN SUBIDA INDIVIDUAL",{fileName:i,errorName:t.name,errorMessage:t.message,errorStack:t.stack,timestamp:new Date().toISOString()}),e.status="error",e.error=this.getErrorMessage(t),console.log("\u274C Estado actualizado a error",{fileName:i,error:this.getErrorMessage(t)});let d=this.getErrorMessage(t);this.snackBar.open(`Error subiendo "${i}": ${d}`,"Cerrar",{duration:3e3}),console.log("\u{1F514} Notificaci\xF3n de error mostrada",{fileName:i,errorMessage:d})}finally{this.currentUploads--}})}getStatusIcon(e){switch(e){case"pending":return"schedule";case"uploading":return"cloud_upload";case"success":return"check_circle";case"error":return"error";default:return"help"}}getStatusColor(e){switch(e){case"pending":return"#FF9800";case"uploading":return"#2196F3";case"success":return"#4CAF50";case"error":return"#F44336";default:return"#9E9E9E"}}getStatusText(e){switch(e){case"pending":return"Pendiente";case"uploading":return"Subiendo...";case"success":return"Subida exitosa";case"error":return"Error";default:return"Desconocido"}}hasPendingImages(){return this.previewImages.some(e=>e.status==="pending")}getPendingCount(){return this.previewImages.filter(e=>e.status==="pending").length}clearAllPreviews(){console.log("\u{1F9F9} Limpiando todas las previsualizaciones. Total actual:",this.previewImages.length),this.previewImages.forEach(e=>{e.url.startsWith("blob:")&&(URL.revokeObjectURL(e.url),console.log("\u{1F9F9} URL de blob revocada para:",e.file.name))}),this.previewImages=[],this.selectedFiles=[],this.cdr.detectChanges(),console.log("\u2705 Todas las previsualizaciones limpiadas y vista actualizada")}eliminarEvidencia(e){if(!e.id){console.error("ID de evidencia no v\xE1lido"),this.snackBar.open("Error: ID de evidencia no v\xE1lido","Cerrar",{duration:3e3});return}let i=`\xBFEst\xE1s seguro de que deseas eliminar esta evidencia?

Archivo: ${e.nombre_archivo||"Sin nombre"}
Descripci\xF3n: ${e.descripcion||"Sin descripci\xF3n"}`;confirm(i)&&(console.log("\u{1F5D1}\uFE0F Iniciando eliminaci\xF3n de evidencia:",{id:e.id,nombre:e.nombre_archivo,url:e.url_imagen}),this.snackBar.open("Eliminando evidencia...","",{duration:1e3}),this.evidenciaService.eliminarEvidencia(e.id).subscribe({next:t=>{t?(console.log("\u2705 Evidencia eliminada exitosamente:",e.id),this.evidencias=this.evidencias.filter(d=>d.id!==e.id),this.loadEvidencias(),this.snackBar.open("Evidencia eliminada correctamente","Cerrar",{duration:3e3,panelClass:["success-snackbar"]})):(console.error("\u274C La eliminaci\xF3n no fue exitosa"),this.snackBar.open("Error: La eliminaci\xF3n no fue exitosa","Cerrar",{duration:5e3,panelClass:["error-snackbar"]}))},error:t=>{console.error("\u274C Error eliminando evidencia:",{evidenciaId:e.id,error:t,errorMessage:t?.message,errorCode:t?.code});let d="Error eliminando evidencia";t?.message&&(t.message.includes("permission")?d="No tienes permisos para eliminar esta evidencia":t.message.includes("not found")?(d="La evidencia ya no existe",this.evidencias=this.evidencias.filter(m=>m.id!==e.id)):t.message.includes("storage")?d="Error eliminando el archivo. El registro fue eliminado.":d=`Error: ${t.message}`),this.snackBar.open(d,"Cerrar",{duration:5e3,panelClass:["error-snackbar"]})}}))}actualizarDescripcion(e,i){return h(this,null,function*(){if(!e.id){console.error("ID de evidencia no v\xE1lido");return}try{yield this.evidenciaService.actualizarEvidencia(e.id,{descripcion:i}),e.descripcion=i,this.snackBar.open("Descripci\xF3n actualizada","Cerrar",{duration:2e3})}catch(t){console.error("Error actualizando descripci\xF3n:",t),this.snackBar.open("Error actualizando descripci\xF3n","Cerrar",{duration:3e3})}})}volver(){this.router.navigate(["/actividades"])}static{this.\u0275fac=function(i){return new(i||o)(b(G),b(H),b(Me),b(be),b(ye),b(ge),b(U))}}static{this.\u0275cmp=V({type:o,selectors:[["app-detalle-actividad"]],decls:9,vars:2,consts:[["fileInput",""],[1,"detalle-actividad-container"],[1,"header-section"],["mat-icon-button","",1,"back-button",3,"click"],["class","loading-container",4,"ngIf"],[4,"ngIf"],[1,"loading-container"],[1,"activity-info"],[1,"estado-badge"],[1,"description"],[1,"activity-details"],[1,"detail-row"],[1,"detail-item"],["class","detail-item",4,"ngIf"],[1,"tasks-section"],[1,"progress-container"],[1,"progress-info"],[1,"progress-label"],[1,"progress-percentage"],["mode","determinate",3,"value","color"],["class","tasks-list",4,"ngIf"],["class","loading-tasks",4,"ngIf"],[1,"evidence-section"],[1,"upload-zone",3,"dragover","dragleave","drop"],[1,"upload-content"],[1,"upload-icon"],["type","file","multiple","","accept","image/*",2,"display","none",3,"change"],["mat-raised-button","","color","primary",3,"click","disabled"],["class","preview-section",4,"ngIf"],["class","evidence-gallery",4,"ngIf"],["class","loading-evidence",4,"ngIf"],["class","no-evidence",4,"ngIf"],[1,"tasks-list"],[1,"tasks-header"],["mat-icon-button","","title","Refrescar tareas",3,"click"],["class","no-tasks",4,"ngIf"],["class","task-item",4,"ngFor","ngForOf"],[1,"no-tasks"],[1,"debug-info"],[1,"task-item"],[3,"change","checked","color"],[1,"task-content"],[1,"task-header"],[1,"task-name"],[1,"task-order"],["class","task-description",4,"ngIf"],["class","task-meta",4,"ngIf"],[1,"task-description"],[1,"task-meta"],[1,"loading-tasks"],[1,"preview-section"],[1,"preview-grid"],["class","preview-item",4,"ngFor","ngForOf"],[1,"upload-actions"],["diameter","20","style","margin-right: 8px;",4,"ngIf"],["mat-button","",3,"click","disabled"],[1,"preview-item"],[1,"preview-image-container"],[1,"preview-image",3,"src","alt"],[1,"preview-overlay",3,"ngClass"],[1,"status-indicator"],[1,"status-text"],["mode","determinate","class","upload-progress",3,"value",4,"ngIf"],["class","error-message",4,"ngIf"],[1,"preview-actions"],["mat-icon-button","","color","warn","matTooltip","Eliminar",3,"click",4,"ngIf"],["mat-icon-button","","color","primary","matTooltip","Reintentar",3,"click",4,"ngIf"],["mat-icon-button","","color","primary","matTooltip","Subir esta imagen",3,"click",4,"ngIf"],[1,"preview-info"],[1,"file-details"],[1,"file-name"],[1,"file-size"],["appearance","outline","class","description-field",4,"ngIf"],["mode","determinate",1,"upload-progress",3,"value"],[1,"error-message"],["mat-icon-button","","color","warn","matTooltip","Eliminar",3,"click"],["mat-icon-button","","color","primary","matTooltip","Reintentar",3,"click"],["mat-icon-button","","color","primary","matTooltip","Subir esta imagen",3,"click"],["appearance","outline",1,"description-field"],["matInput","","placeholder","Describe esta imagen...",3,"input","value","disabled"],["diameter","20",2,"margin-right","8px"],[1,"evidence-gallery"],[1,"gallery-grid"],["class","evidence-item",4,"ngFor","ngForOf"],[1,"evidence-item"],[1,"image-container"],[1,"evidence-image",3,"src","alt"],[1,"image-overlay"],["mat-icon-button","","color","warn","matTooltip","Eliminar evidencia",3,"click"],[1,"evidence-info"],["matInput","","placeholder","Agregar descripci\xF3n...",3,"blur","value"],[1,"evidence-meta"],[1,"upload-date"],[1,"loading-evidence"],["diameter","40"],[1,"no-evidence"],[1,"hint"]],template:function(i,t){i&1&&(a(0,"div",1)(1,"div",2)(2,"button",3),u("click",function(){return t.volver()}),a(3,"mat-icon"),s(4,"arrow_back"),n()(),a(5,"h1"),s(6,"Detalle de Actividad"),n()(),_(7,Se,5,0,"div",4)(8,Ke,78,31,"div",5),n()),i&2&&(r(7),c("ngIf",t.loading),r(),c("ngIf",!t.loading&&t.actividad))},dependencies:[X,R,$,L,j,Q,ee,q,J,Y,K,Z,de,se,re,le,ce,Oe,Ee,he,fe,Pe,we,_e,ue,ve,xe,me,pe,oe,ae,ie,te,ne,Ie,Ce,W],styles:['@charset "UTF-8";.detalle-actividad-container[_ngcontent-%COMP%]{padding:20px;max-width:1000px;margin:0 auto}.header-section[_ngcontent-%COMP%]{display:flex;align-items:center;margin-bottom:20px;gap:16px}.header-section[_ngcontent-%COMP%]   h1[_ngcontent-%COMP%]{margin:0;font-size:24px;font-weight:500}.back-button[_ngcontent-%COMP%]{color:#666}.activity-info[_ngcontent-%COMP%]{margin-bottom:20px}.estado-badge[_ngcontent-%COMP%]{padding:4px 12px;border-radius:12px;color:#fff;font-size:12px;font-weight:500;text-transform:uppercase}.description[_ngcontent-%COMP%]{margin:16px 0;color:#666;line-height:1.5}.activity-details[_ngcontent-%COMP%]{margin-top:16px}.detail-row[_ngcontent-%COMP%]{display:flex;gap:32px;margin-bottom:12px}.detail-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;color:#666}.detail-item[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:18px;width:18px;height:18px}.tasks-section[_ngcontent-%COMP%], .progress-container[_ngcontent-%COMP%]{margin-bottom:20px}.progress-info[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.progress-label[_ngcontent-%COMP%]{font-weight:500;color:#333}.progress-percentage[_ngcontent-%COMP%]{font-weight:600;color:#1976d2}mat-divider[_ngcontent-%COMP%]{margin:20px 0}.tasks-list[_ngcontent-%COMP%]{margin-top:20px}.tasks-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}.tasks-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:18px;font-weight:500}.no-tasks[_ngcontent-%COMP%]{text-align:center;padding:40px 20px;color:#666}.debug-info[_ngcontent-%COMP%]{font-size:12px;color:#999;margin-top:8px}.no-tasks[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:48px;width:48px;height:48px;margin-bottom:16px;opacity:.5}.task-item[_ngcontent-%COMP%]{display:flex;align-items:flex-start;gap:16px;padding:16px 0;border-bottom:1px solid #eee}.task-item[_ngcontent-%COMP%]:last-child{border-bottom:none}.task-content[_ngcontent-%COMP%]{flex:1}.task-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}.task-name[_ngcontent-%COMP%]{font-weight:500;color:#333;transition:all .3s ease}.task-name.completed[_ngcontent-%COMP%]{text-decoration:line-through;color:#999}.task-order[_ngcontent-%COMP%]{background:#f5f5f5;padding:2px 8px;border-radius:12px;font-size:12px;color:#666}.task-description[_ngcontent-%COMP%]{margin:8px 0;color:#666;font-size:14px;line-height:1.4}.task-meta[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;color:#4caf50;font-size:12px;margin-top:8px}.task-meta[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:16px;width:16px;height:16px}.loading-container[_ngcontent-%COMP%], .loading-tasks[_ngcontent-%COMP%]{text-align:center;padding:20px;color:#666}.evidence-section[_ngcontent-%COMP%]{margin-bottom:20px}.upload-zone[_ngcontent-%COMP%]{border:2px dashed #ccc;border-radius:8px;padding:40px 20px;text-align:center;transition:all .3s ease;cursor:pointer;margin-bottom:20px}.upload-zone[_ngcontent-%COMP%]:hover, .upload-zone.drag-over[_ngcontent-%COMP%]{border-color:#1976d2;background-color:#f3f8ff}.upload-content[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:16px}.upload-icon[_ngcontent-%COMP%]{font-size:48px;width:48px;height:48px;color:#666}.upload-zone[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{margin:0;color:#666;font-size:16px}.selected-files[_ngcontent-%COMP%]{margin-bottom:20px;padding:16px;background-color:#f9f9f9;border-radius:8px}.selected-files[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 16px;font-size:16px;font-weight:500}.file-list[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}.file-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:12px;padding:8px 12px;background-color:#fff;border-radius:6px;border:1px solid #e0e0e0}.file-name[_ngcontent-%COMP%]{flex:1;font-weight:500}.file-size[_ngcontent-%COMP%]{color:#666;font-size:12px}.upload-actions[_ngcontent-%COMP%]{display:flex;gap:12px;align-items:center}.preview-section[_ngcontent-%COMP%]{margin-top:20px}.preview-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin:16px 0}.preview-item[_ngcontent-%COMP%]{border:2px solid #e0e0e0;border-radius:8px;overflow:hidden;background:#fff;transition:all .3s ease}.preview-item[data-status=pending][_ngcontent-%COMP%]{border-color:#ff9800}.preview-item[data-status=uploading][_ngcontent-%COMP%]{border-color:#2196f3}.preview-item[data-status=success][_ngcontent-%COMP%]{border-color:#4caf50}.preview-item[data-status=error][_ngcontent-%COMP%]{border-color:#f44336}.preview-image-container[_ngcontent-%COMP%]{position:relative;width:100%;height:150px;overflow:hidden}.preview-image[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;display:block}.preview-overlay[_ngcontent-%COMP%]{position:absolute;inset:0;background:#000000b3;display:flex;flex-direction:column;justify-content:center;align-items:center;opacity:0;transition:opacity .3s ease}.preview-item[_ngcontent-%COMP%]:hover   .preview-overlay[_ngcontent-%COMP%], .preview-overlay.status-uploading[_ngcontent-%COMP%], .preview-overlay.status-error[_ngcontent-%COMP%]{opacity:1}.status-indicator[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:4px;color:#fff}.status-text[_ngcontent-%COMP%]{font-size:12px;font-weight:500}.upload-progress[_ngcontent-%COMP%]{width:80%;margin-top:8px}.error-message[_ngcontent-%COMP%]{color:#ffcdd2;text-align:center;margin-top:8px;padding:0 8px}.preview-actions[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .3s ease}.preview-item[_ngcontent-%COMP%]:hover   .preview-actions[_ngcontent-%COMP%]{opacity:1}.preview-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{background:#ffffffe6;width:32px;height:32px;min-width:unset}.preview-info[_ngcontent-%COMP%]{padding:12px}.file-details[_ngcontent-%COMP%]{margin-bottom:8px}.file-name[_ngcontent-%COMP%]{display:block;font-weight:500;font-size:14px;color:#333;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.file-size[_ngcontent-%COMP%]{font-size:12px;color:#666}.description-field[_ngcontent-%COMP%]{width:100%;margin-top:8px}.description-field[_ngcontent-%COMP%]   .mat-mdc-form-field-wrapper[_ngcontent-%COMP%]{padding-bottom:0}@media (max-width: 768px){.preview-grid[_ngcontent-%COMP%]{grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:12px}.preview-image-container[_ngcontent-%COMP%]{height:120px}.preview-info[_ngcontent-%COMP%]{padding:8px}.upload-actions[_ngcontent-%COMP%]{flex-direction:column}.upload-actions[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{width:100%}}.evidence-gallery[_ngcontent-%COMP%]{margin-top:20px}.evidence-gallery[_ngcontent-%COMP%]   h4[_ngcontent-%COMP%]{margin:0 0 16px;font-size:16px;font-weight:500}.gallery-grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:20px}.evidence-item[_ngcontent-%COMP%]{border:1px solid #e0e0e0;border-radius:8px;overflow:hidden;background-color:#fff}.image-container[_ngcontent-%COMP%]{position:relative;width:100%;height:200px;overflow:hidden}.evidence-image[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover;transition:transform .3s ease}.evidence-image[_ngcontent-%COMP%]:hover{transform:scale(1.05)}.image-overlay[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px;opacity:0;transition:opacity .3s ease}.image-container[_ngcontent-%COMP%]:hover   .image-overlay[_ngcontent-%COMP%]{opacity:1}.evidence-info[_ngcontent-%COMP%]{padding:16px}.description-field[_ngcontent-%COMP%]{width:100%;margin-bottom:12px}.evidence-meta[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px}.upload-date[_ngcontent-%COMP%]{display:flex;align-items:center;gap:4px;color:#666;font-size:12px}.upload-date[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:14px;width:14px;height:14px}.loading-evidence[_ngcontent-%COMP%], .no-evidence[_ngcontent-%COMP%]{text-align:center;padding:40px 20px;color:#666}.loading-evidence[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:center;gap:16px}.no-evidence[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:48px;width:48px;height:48px;margin-bottom:16px;opacity:.5}.no-evidence[_ngcontent-%COMP%]   .hint[_ngcontent-%COMP%]{font-size:14px;color:#999;margin-top:8px}@media (max-width: 768px){.detalle-actividad-container[_ngcontent-%COMP%]{padding:16px}.detail-row[_ngcontent-%COMP%]{flex-direction:column;gap:12px}.task-header[_ngcontent-%COMP%]{flex-direction:column;align-items:flex-start;gap:8px}.gallery-grid[_ngcontent-%COMP%]{grid-template-columns:1fr}.upload-zone[_ngcontent-%COMP%]{padding:20px 16px}.upload-actions[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch}}']})}}return o})();export{Ft as DetalleActividadComponent};
