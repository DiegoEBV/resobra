import{a as _}from"./chunk-NQRH7R5J.js";import{a as h}from"./chunk-QDNB5NC6.js";import{a as I}from"./chunk-FIG454EI.js";import{a as E}from"./chunk-WFXXN3GR.js";import{E as S,ba as d,ga as l,k as c,q as p}from"./chunk-B6672ACT.js";import{a as g,b as f,i as m}from"./chunk-ODN5LVDJ.js";var v=(()=>{class n{constructor(t,e,i,r){this.supabase=t,this.reportsService=e,this.itemsService=i,this.projectsService=r,this.STORAGE_KEYS={AUTOCOMPLETE:"bitepoint_autocomplete_data",FAVORITES:"bitepoint_favorite_items",QUICK_TEMPLATES:"bitepoint_quick_templates",LAST_BACKUP:"bitepoint_last_backup"},this.initializeAutoBackup()}getAutoCompleteData(){let t=localStorage.getItem(this.STORAGE_KEYS.AUTOCOMPLETE);return t?JSON.parse(t):{descriptions:[],quantities:[],observations:[]}}updateAutoCompleteData(t){return new Promise(e=>{this.updateAutoCompleteField("descriptions",t.description),this.updateAutoCompleteField("quantities",t.quantity.toString()),e()})}updateAutoCompleteField(t,e){let i=this.getAutoCompleteData();if(t==="quantities"&&typeof e=="number")i.quantities.includes(e)||(i.quantities.push(e),i.quantities.sort((r,o)=>o-r),i.quantities=i.quantities.slice(0,10));else if(typeof e=="string"&&e.trim()){let r=t;i[r].includes(e)||(i[r].unshift(e),i[r]=i[r].slice(0,20))}localStorage.setItem(this.STORAGE_KEYS.AUTOCOMPLETE,JSON.stringify(i))}getAutoCompleteSuggestions(t,e){let r=this.getAutoCompleteData()[t];return e.trim()?r.filter(o=>o.toLowerCase().includes(e.toLowerCase())).slice(0,5):r.slice(0,5)}getFavoriteItems(){let t=localStorage.getItem(this.STORAGE_KEYS.FAVORITES);if(!t)return c([]);let e=JSON.parse(t);return e.map(r=>r.item_id).length===0?c([]):this.itemsService.getAllItems().pipe(p(r=>e.map(s=>{let a=r.find(u=>u.id===s.item_id);return a?f(g({},s),{item:a}):null}).filter(s=>s!==null).sort((s,a)=>a.usage_count-s.usage_count)),S(()=>c([])))}markItemAsUsed(t){let e=localStorage.getItem(this.STORAGE_KEYS.FAVORITES),i=e?JSON.parse(e):[],r=i.findIndex(o=>o.item_id===t);if(r>=0)i[r].usage_count++,i[r].last_used=new Date().toISOString();else{this.itemsService.getItemById(t).subscribe(o=>{o&&(i.push({item_id:t,item:o,usage_count:1,last_used:new Date().toISOString()}),localStorage.setItem(this.STORAGE_KEYS.FAVORITES,JSON.stringify(i)))});return}localStorage.setItem(this.STORAGE_KEYS.FAVORITES,JSON.stringify(i))}getLastReport(t){return this.reportsService.getReportsByProject(t).pipe(p(e=>e.length>0?e[0]:null),S(()=>c(null)))}copyPreviousReport(t){return m(this,null,function*(){try{let e=yield this.reportsService.getReportById(t).toPromise();if(!e)throw new Error("Reporte no encontrado");let i=e.report_items||[],r=yield this.projectsService.getProjectById(e.project_id).toPromise();return{items:i,project:r}}catch(e){throw e}})}getQuickReportTemplate(t){let e=localStorage.getItem(this.STORAGE_KEYS.QUICK_TEMPLATES);return e&&JSON.parse(e)[t]||null}getQuickReportTemplates(){let t=localStorage.getItem(this.STORAGE_KEYS.QUICK_TEMPLATES);if(!t)return[];let e=JSON.parse(t);return Object.values(e)}saveQuickReportTemplate(t){let e=localStorage.getItem(this.STORAGE_KEYS.QUICK_TEMPLATES),i=e?JSON.parse(e):{},r=t.items.map(s=>s.item?.id).filter(s=>s),o={};t.items.forEach(s=>{s.item?.id&&s.currentQuantity&&(o[s.item.id]=s.currentQuantity)}),i[t.projectId]={project_id:t.projectId,favorite_items:r,default_quantities:o},localStorage.setItem(this.STORAGE_KEYS.QUICK_TEMPLATES,JSON.stringify(i))}createQuickReportFromTemplate(t,e){return m(this,null,function*(){try{let i=this.getQuickReportTemplate(e);if(!i)throw new Error("Plantilla no encontrada");let r=(yield this.itemsService.getAllItems().toPromise())||[];return{items:i.favorite_items.map(a=>r.find(u=>u.id===a)).filter(a=>a!==void 0).map(a=>({item:a,currentQuantity:i.default_quantities[a.id]||1,previousQuantity:0}))}}catch(i){throw i}})}createQuickReport(t){let e=this.getQuickReportTemplate(t);return e?this.itemsService.getAllItems().pipe(p(i=>{let r=e.favorite_items.map(o=>i.find(s=>s.id===o)).filter(o=>o!==void 0);return this.generateQuickReportData(t,r)})):this.getFavoriteItems().pipe(p(i=>{let r=i.slice(0,5);return this.generateQuickReportData(t,r.map(o=>o.item))}))}generateQuickReportData(t,e){let i=new Date,r=`INF-${i.getFullYear()}-${(Math.floor(Math.random()*900)+100).toString()}`;return{report:{project_id:t,report_number:r,report_date:i.toISOString().split("T")[0],period_start:void 0,period_end:void 0,status:"draft"},items:e}}performBackup(){return new Promise((t,e)=>{try{this.performAutoBackup(),t()}catch(i){e(i)}})}initializeAutoBackup(){return new Promise(t=>{this.initializeAutoBackupInternal(),t()})}initializeAutoBackupInternal(){let t=localStorage.getItem(this.STORAGE_KEYS.LAST_BACKUP),e=new Date().getTime(),i=24*60*60*1e3;(!t||e-parseInt(t)>i)&&this.performAutoBackup()}performAutoBackup(){try{let t={timestamp:new Date().toISOString(),autocomplete:this.getAutoCompleteData(),favorites:localStorage.getItem(this.STORAGE_KEYS.FAVORITES),templates:localStorage.getItem(this.STORAGE_KEYS.QUICK_TEMPLATES)},e=`bitepoint_backup_${new Date().toISOString().split("T")[0]}`;localStorage.setItem(e,JSON.stringify(t)),this.cleanOldBackups(),localStorage.setItem(this.STORAGE_KEYS.LAST_BACKUP,new Date().getTime().toString())}catch{}}cleanOldBackups(){let t=new Date;t.setDate(t.getDate()-7);let e=t.toISOString().split("T")[0];Object.keys(localStorage).filter(i=>i.startsWith("bitepoint_backup_")).forEach(i=>{i.replace("bitepoint_backup_","")<e&&localStorage.removeItem(i)})}restoreFromBackup(t){try{let e=`bitepoint_backup_${t}`,i=localStorage.getItem(e);if(!i)return!1;let r=JSON.parse(i);return r.autocomplete&&localStorage.setItem(this.STORAGE_KEYS.AUTOCOMPLETE,JSON.stringify(r.autocomplete)),r.favorites&&localStorage.setItem(this.STORAGE_KEYS.FAVORITES,r.favorites),r.templates&&localStorage.setItem(this.STORAGE_KEYS.QUICK_TEMPLATES,r.templates),!0}catch{return!1}}getAvailableBackups(){return Object.keys(localStorage).filter(t=>t.startsWith("bitepoint_backup_")).map(t=>t.replace("bitepoint_backup_","")).sort().reverse()}static{this.\u0275fac=function(e){return new(e||n)(l(E),l(_),l(I),l(h))}}static{this.\u0275prov=d({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{v as a};
