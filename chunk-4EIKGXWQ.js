import{c as f}from"./chunk-ZJYJPMQY.js";import{ba as m,g as d,ga as p}from"./chunk-OYRL5FJJ.js";import{a as n,b as c,i}from"./chunk-ODN5LVDJ.js";var j=(()=>{class u{constructor(e){this.supabase=e,this.evaluacionesSubject=new d([]),this.rubricasSubject=new d([]),this.criteriosSubject=new d([]),this.evaluaciones$=this.evaluacionesSubject.asObservable(),this.rubricas$=this.rubricasSubject.asObservable(),this.criterios$=this.criteriosSubject.asObservable(),this.loadInitialData()}loadInitialData(){return i(this,null,function*(){try{yield Promise.all([this.loadEvaluaciones(),this.loadRubricas(),this.loadCriterios()])}catch(e){console.error("Error loading initial evaluation data:",e)}})}loadEvaluaciones(){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("evaluaciones").select(`
          *,
          evaluado:users!evaluado_id(nombre),
          evaluador:users!evaluador_id(nombre),
          rubrica:rubricas_evaluacion(nombre)
        `).order("created_at",{ascending:!1});if(r)throw r;let o=e?.map(a=>c(n({},a),{evaluado_nombre:a.evaluado?.nombre,evaluador_nombre:a.evaluador?.nombre,rubrica_nombre:a.rubrica?.nombre}))||[];this.evaluacionesSubject.next(o)}catch(e){throw console.error("Error loading evaluaciones:",e),e}})}loadRubricas(){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("rubricas_evaluacion").select(`
          *,
          criterios:criterios_evaluacion(*)
        `).eq("activa",!0).order("nombre");if(r)throw r;this.rubricasSubject.next(e||[])}catch(e){throw console.error("Error loading rubricas:",e),e}})}loadCriterios(){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("criterios_evaluacion").select("*").order("nombre");if(r)throw r;this.criteriosSubject.next(e||[])}catch(e){throw console.error("Error loading criterios:",e),e}})}createEvaluacion(e){return i(this,null,function*(){try{let r=yield this.supabase.getCurrentUserId();if(!e.evaluado_id)throw new Error("El ID del empleado a evaluar es requerido");if(!e.rubrica_id)throw new Error("La r\xFAbrica de evaluaci\xF3n es requerida");if(!e.calificaciones||Object.keys(e.calificaciones).length===0)throw new Error("Las calificaciones son requeridas");let{data:o,error:a}=yield this.supabase.client.from("evaluaciones").insert(c(n({},e),{evaluador_id:r,created_at:new Date().toISOString()})).select().single();if(a)throw console.error("Error de Supabase al crear evaluaci\xF3n:",a),a.code==="PGRST204"?new Error("Error de estructura de base de datos. Contacte al administrador."):a.code==="23505"?new Error("Ya existe una evaluaci\xF3n para este empleado en este per\xEDodo."):a.code==="23503"?new Error("Datos de referencia inv\xE1lidos. Verifique el empleado y la r\xFAbrica seleccionados."):new Error(`Error al guardar la evaluaci\xF3n: ${a.message}`);return yield this.loadEvaluaciones(),o}catch(r){throw console.error("Error creating evaluacion:",r),r.message&&r.message.includes("requerido")?r:new Error("Error inesperado al crear la evaluaci\xF3n. Intente nuevamente.")}})}updateEvaluacion(e,r){return i(this,null,function*(){try{let{data:o,error:a}=yield this.supabase.client.from("evaluaciones").update(c(n({},r),{updated_at:new Date().toISOString()})).eq("id",e).select().single();if(a)throw a;return yield this.loadEvaluaciones(),o}catch(o){throw console.error("Error updating evaluacion:",o),o}})}calcularPuntuacionTotal(e,r){let o=0,a=0;return r.forEach(t=>{let h=e[t.id]||0;o+=h*t.peso/100,a+=t.peso}),a>0&&a!==100&&(o=o*100/a),Math.round(o*100)/100}getEmpleadosParaEvaluar(){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("users").select("id, nombre, email, rol").order("nombre");if(r)throw r;return e||[]}catch(e){return console.error("Error getting empleados:",e),[]}})}getResumenEvaluaciones(){return i(this,null,function*(){try{let e=yield this.getEmpleadosParaEvaluar(),r=this.evaluacionesSubject.value;return e.map(a=>{let t=r.filter(s=>s.evaluado_id===a.id&&s.estado==="aprobada"),h=t.length>0?t.reduce((s,l)=>s+l.puntuacion_total,0)/t.length:0,w=t.length>0?t.sort((s,l)=>new Date(l.fecha_evaluacion).getTime()-new Date(s.fecha_evaluacion).getTime())[0].fecha_evaluacion:"",b="estable";if(t.length>=2){let s=t.sort((g,E)=>new Date(g.fecha_evaluacion).getTime()-new Date(E.fecha_evaluacion).getTime()),l=s[0].puntuacion_total,v=s[s.length-1].puntuacion_total;v>l+5?b="mejorando":v<l-5&&(b="declinando")}return{empleado_id:a.id,empleado_nombre:a.nombre,puesto:a.rol||"No especificado",promedio_general:h,evaluaciones_completadas:t.length,ultima_evaluacion:w,tendencia:b}})}catch(e){return console.error("Error getting resumen evaluaciones:",e),[]}})}createRubrica(e){return i(this,null,function*(){try{let{data:r,error:o}=yield this.supabase.client.from("rubricas_evaluacion").insert(c(n({},e),{created_at:new Date().toISOString()})).select().single();if(o)throw o;return yield this.loadRubricas(),r}catch(r){throw console.error("Error creating rubrica:",r),r}})}createCriterio(e){return i(this,null,function*(){try{let{data:r,error:o}=yield this.supabase.client.from("criterios_evaluacion").insert(c(n({},e),{created_at:new Date().toISOString()})).select().single();if(o)throw o;return yield this.loadCriterios(),r}catch(r){throw console.error("Error creating criterio:",r),r}})}refresh(){return i(this,null,function*(){yield this.loadInitialData()})}getEvaluacionById(e){return i(this,null,function*(){try{let{data:r,error:o}=yield this.supabase.client.from("evaluaciones").select(`
          *,
          evaluado:users!evaluado_id(nombre),
          evaluador:users!evaluador_id(nombre),
          rubrica:rubricas_evaluacion(nombre)
        `).eq("id",e).single();if(o)throw o;return c(n({},r),{evaluado_nombre:r.evaluado?.nombre,evaluador_nombre:r.evaluador?.nombre,rubrica_nombre:r.rubrica?.nombre})}catch(r){return console.error("Error getting evaluacion by id:",r),null}})}getEstadisticasEvaluaciones(){return i(this,null,function*(){try{let e=this.evaluacionesSubject.value,r={total:e.length,completadas:e.filter(a=>a.estado==="completada"||a.estado==="aprobada").length,pendientes:e.filter(a=>a.estado==="borrador").length,promedio_general:0,por_estado:{borrador:e.filter(a=>a.estado==="borrador").length,completada:e.filter(a=>a.estado==="completada").length,revisada:e.filter(a=>a.estado==="revisada").length,aprobada:e.filter(a=>a.estado==="aprobada").length}},o=e.filter(a=>a.estado==="aprobada");return o.length>0&&(r.promedio_general=o.reduce((a,t)=>a+t.puntuacion_total,0)/o.length),r}catch(e){return console.error("Error getting estadisticas:",e),null}})}static{this.\u0275fac=function(r){return new(r||u)(p(f))}}static{this.\u0275prov=m({token:u,factory:u.\u0275fac,providedIn:"root"})}}return u})();export{j as a};
