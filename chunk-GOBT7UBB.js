import{a as h,b as s}from"./chunk-G7YPFBNB.js";import{t as u,v as l}from"./chunk-4WMI5X77.js";import{ba as a,ga as c}from"./chunk-B6672ACT.js";import{i}from"./chunk-ODN5LVDJ.js";var S=(()=>{class o{constructor(e){this.http=e,this.currentUser=null,this.currentProfile=null,this.accessToken=null,this.supabaseClient=h(s.supabase.url,s.supabase.anonKey,{auth:{storageKey:"sb-direct-auth-token",autoRefreshToken:s.supabase.auth?.autoRefreshToken??!1,persistSession:s.supabase.auth?.persistSession??!1,detectSessionInUrl:s.supabase.auth?.detectSessionInUrl??!1,flowType:"implicit"}}),this.loadStoredAuth()}login(e,r){return i(this,null,function*(){try{console.log("\u{1F510} DirectAuthService - Iniciando login directo...");let{data:t,error:n}=yield this.supabaseClient.auth.signInWithPassword({email:e,password:r});return n?(console.error("\u274C DirectAuthService - Error en login:",n),{user:null,error:n}):t?.user&&t?.session?(this.accessToken=t.session.access_token,this.currentUser=t.user,sessionStorage.setItem("direct_auth_token",this.accessToken),sessionStorage.setItem("direct_auth_user",JSON.stringify(this.currentUser)),yield this.loadUserProfile(),console.log("\u2705 DirectAuthService - Login exitoso"),{user:this.currentUser,error:null}):(console.error("\u274C DirectAuthService - No se recibi\xF3 token de acceso"),{user:null,error:{message:"Error de autenticaci\xF3n"}})}catch(t){return console.error("\u274C DirectAuthService - Error en login:",t),{user:null,error:t}}})}loadStoredAuth(){let e=sessionStorage.getItem("direct_auth_token"),r=sessionStorage.getItem("direct_auth_user"),t=sessionStorage.getItem("direct_auth_profile");e&&r&&(this.accessToken=e,this.currentUser=JSON.parse(r),t&&(this.currentProfile=JSON.parse(t)))}loadUserProfile(){return i(this,null,function*(){if(!(!this.accessToken||!this.currentUser))try{console.log("\u{1F50D} Cargando perfil para user id:",this.currentUser.id);let{data:e,error:r}=yield this.supabaseClient.from("users").select("*").eq("id",this.currentUser.id).single();if(r){console.error("\u274C Error cargando perfil desde tabla users:",r),console.error("Error details:",r);return}e?(this.currentProfile=e,sessionStorage.setItem("direct_auth_profile",JSON.stringify(this.currentProfile)),console.log("\u2705 Perfil cargado exitosamente:",this.currentProfile),console.log("\u2705 Rol del usuario:",this.currentProfile.rol)):console.warn("\u26A0\uFE0F No se encontr\xF3 perfil para el usuario")}catch(e){console.error("\u274C Error en loadUserProfile:",e)}})}getCurrentUser(){return this.currentUser}getCurrentProfile(){return this.currentProfile}isAuthenticated(){return!!this.accessToken&&!!this.currentUser}getAccessToken(){return this.accessToken}logout(){return i(this,null,function*(){try{yield this.supabaseClient.auth.signOut()}catch(e){console.error("Error en logout:",e)}finally{this.accessToken=null,this.currentUser=null,this.currentProfile=null,sessionStorage.removeItem("direct_auth_token"),sessionStorage.removeItem("direct_auth_user"),sessionStorage.removeItem("direct_auth_profile")}})}getAuthHeaders(){return new u({"Content-Type":"application/json",apikey:s.supabase.anonKey,Authorization:`Bearer ${this.accessToken}`})}static{this.\u0275fac=function(r){return new(r||o)(c(l))}}static{this.\u0275prov=a({token:o,factory:o.\u0275fac,providedIn:"root"})}}return o})();export{S as a};
