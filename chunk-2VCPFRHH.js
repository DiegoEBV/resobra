import{a as h}from"./chunk-GOBT7UBB.js";import{a as p,b as s}from"./chunk-G7YPFBNB.js";import{ba as _,g as l,ga as g}from"./chunk-B6672ACT.js";import{a as d,b,i}from"./chunk-ODN5LVDJ.js";var S=(()=>{class c{constructor(e){this.directAuthService=e,this.evaluacionesSubject=new l([]),this.rubricasSubject=new l([]),this.criteriosSubject=new l([]),this.evaluaciones$=this.evaluacionesSubject.asObservable(),this.rubricas$=this.rubricasSubject.asObservable(),this.criterios$=this.criteriosSubject.asObservable(),this.supabase=p(s.supabase.url,s.supabase.anonKey,{auth:{storageKey:"sb-evaluaciones-auth-token",autoRefreshToken:!1,persistSession:!1}}),this.loadInitialData()}loadInitialData(){return i(this,null,function*(){try{yield Promise.all([this.loadEvaluaciones(),this.loadRubricas(),this.loadCriterios()])}catch(e){console.error("Error loading initial data:",e)}})}loadEvaluaciones(){return i(this,null,function*(){try{console.log("Cargando evaluaciones desde Supabase...");let{data:e,error:o}=yield this.supabase.from("evaluaciones").select(`
          *,
          evaluado:evaluado_id(nombre, email),
          evaluador:evaluador_id(nombre, email)
        `).order("created_at",{ascending:!1});if(o){console.error("Error cargando evaluaciones:",o);let a=[{id:"1",evaluado_id:"1",evaluado_nombre:"Juan P\xE9rez",tipo_evaluacion:"desempe\xF1o",fecha_evaluacion:"2024-01-15",conocimiento_tecnico:4,calidad_trabajo:4,productividad:3,seguridad_laboral:5,trabajo_equipo:4,comunicacion:3,liderazgo:3,adaptabilidad:4,puntualidad:5,iniciativa:3,compromiso:4,resolucion_problemas:4,puntuacion_total:3.8,calificacion_general:"bueno",estado:"completada",requiere_seguimiento:"no",fortalezas:"Excelente en seguridad laboral y puntualidad",areas_mejora:"Mejorar comunicaci\xF3n y liderazgo",comentarios_generales:"Empleado confiable con potencial de crecimiento"},{id:"2",evaluado_id:"2",evaluado_nombre:"Mar\xEDa Garc\xEDa",tipo_evaluacion:"desempe\xF1o",fecha_evaluacion:"2024-01-20",conocimiento_tecnico:5,calidad_trabajo:5,productividad:4,seguridad_laboral:4,trabajo_equipo:5,comunicacion:5,liderazgo:4,adaptabilidad:4,puntualidad:4,iniciativa:5,compromiso:5,resolucion_problemas:4,puntuacion_total:4.5,calificacion_general:"excelente",estado:"aprobada",requiere_seguimiento:"no",fortalezas:"Liderazgo natural y excelente comunicaci\xF3n",areas_mejora:"Continuar desarrollando habilidades t\xE9cnicas",comentarios_generales:"Candidata ideal para promoci\xF3n"}];this.evaluacionesSubject.next(a);return}console.log("Evaluaciones cargadas:",e);let r=e.map(a=>b(d({},a),{evaluado_nombre:a.evaluado?.nombre||`Usuario ${a.evaluado_id}`,evaluador_nombre:a.evaluador?.nombre||`Evaluador ${a.evaluador_id}`}));this.evaluacionesSubject.next(r)}catch(e){throw console.error("Error loading evaluaciones:",e),e}})}loadRubricas(){return i(this,null,function*(){try{let e=[{id:"1",nombre:"Evaluaci\xF3n de Desempe\xF1o General",descripcion:"R\xFAbrica est\xE1ndar para evaluaci\xF3n de desempe\xF1o",activa:!0,criterios:[{id:"1",nombre:"Conocimiento T\xE9cnico",descripcion:"Dominio de habilidades t\xE9cnicas requeridas",peso:.2,categoria:"tecnica"},{id:"2",nombre:"Trabajo en Equipo",descripcion:"Capacidad de colaborar efectivamente",peso:.15,categoria:"interpersonal"}]}];this.rubricasSubject.next(e)}catch(e){throw console.error("Error loading rubricas:",e),e}})}loadCriterios(){return i(this,null,function*(){try{let e=[{id:"1",nombre:"Conocimiento T\xE9cnico",descripcion:"Dominio de habilidades t\xE9cnicas requeridas para el puesto",peso:.2,categoria:"tecnica"},{id:"2",nombre:"Calidad del Trabajo",descripcion:"Precisi\xF3n y excelencia en la ejecuci\xF3n de tareas",peso:.15,categoria:"tecnica"},{id:"3",nombre:"Trabajo en Equipo",descripcion:"Capacidad de colaborar efectivamente con colegas",peso:.15,categoria:"interpersonal"},{id:"4",nombre:"Comunicaci\xF3n",descripcion:"Habilidad para transmitir informaci\xF3n clara y efectivamente",peso:.1,categoria:"interpersonal"},{id:"5",nombre:"Puntualidad",descripcion:"Cumplimiento de horarios y compromisos",peso:.1,categoria:"organizacional"}];this.criteriosSubject.next(e)}catch(e){throw console.error("Error loading criterios:",e),e}})}createEvaluacion(e){return i(this,null,function*(){try{if(!e.evaluado_id)throw new Error("El ID del empleado evaluado es requerido");e.puntuacion_total||(e.puntuacion_total=this.calcularPuntuacionTotal(e)),e.calificacion_general||(e.calificacion_general=this.determinarCalificacionGeneral(e.puntuacion_total));let o=this.directAuthService.getCurrentUser();if(!o)throw new Error("Usuario no autenticado");let r=yield this.getDefaultObraId(),a={evaluador_id:o.id,evaluado_id:e.evaluado_id,obra_id:r,tipo_evaluacion:e.tipo_evaluacion||"desempe\xF1o",fecha_evaluacion:e.fecha_evaluacion,estado:e.estado||"completada",conocimiento_tecnico:e.conocimiento_tecnico||3,obs_conocimiento_tecnico:e.obs_conocimiento_tecnico||"",calidad_trabajo:e.calidad_trabajo||3,obs_calidad_trabajo:e.obs_calidad_trabajo||"",productividad:e.productividad||3,obs_productividad:e.obs_productividad||"",seguridad_laboral:e.seguridad_laboral||3,obs_seguridad_laboral:e.obs_seguridad_laboral||"",resolucion_problemas:e.resolucion_problemas||3,obs_resolucion_problemas:e.obs_resolucion_problemas||"",trabajo_equipo:e.trabajo_equipo||3,obs_trabajo_equipo:e.obs_trabajo_equipo||"",comunicacion:e.comunicacion||3,obs_comunicacion:e.obs_comunicacion||"",liderazgo:e.liderazgo||3,obs_liderazgo:e.obs_liderazgo||"",adaptabilidad:e.adaptabilidad||3,obs_adaptabilidad:e.obs_adaptabilidad||"",puntualidad:e.puntualidad||3,obs_puntualidad:e.obs_puntualidad||"",iniciativa:e.iniciativa||3,obs_iniciativa:e.obs_iniciativa||"",compromiso:e.compromiso||3,obs_compromiso:e.obs_compromiso||"",objetivos_cumplidos:e.objetivos_cumplidos||"",objetivos_pendientes:e.objetivos_pendientes||"",porcentaje_cumplimiento:e.porcentaje_cumplimiento||"",fortalezas:e.fortalezas||"",areas_mejora:e.areas_mejora||"",recomendaciones_capacitacion:e.recomendaciones_capacitacion||"",objetivos_proximos:e.objetivos_proximos||"",comentarios_empleado:e.comentarios_empleado||"",requiere_seguimiento:e.requiere_seguimiento||"no",criterios:{fortalezas:e.fortalezas||"",areas_mejora:e.areas_mejora||"",objetivos_cumplidos:e.objetivos_cumplidos||"",objetivos_pendientes:e.objetivos_pendientes||"",plan_desarrollo:e.recomendaciones_capacitacion||"",requiere_seguimiento:e.requiere_seguimiento||"no"},comentarios:e.comentarios_generales||"",puntuacion_total:e.puntuacion_total,calificacion_general:e.calificacion_general};console.log("Insertando evaluaci\xF3n en Supabase:",a);let t=this.directAuthService.getAccessToken();if(!t)throw new Error("No se encontr\xF3 token de autenticaci\xF3n");let n=p(s.supabase.url,s.supabase.anonKey,{global:{headers:{Authorization:`Bearer ${t}`}}}),{data:u,error:m}=yield n.from("evaluaciones").insert([a]).select().single();if(m)throw console.error("Error de Supabase:",m),m;console.log("Evaluaci\xF3n insertada exitosamente:",u);let f=this.evaluacionesSubject.value;return this.evaluacionesSubject.next([...f,u]),u}catch(o){throw console.error("Error creating evaluacion:",o),o.code==="23505"?new Error("Ya existe una evaluaci\xF3n para este empleado en el per\xEDodo seleccionado"):o.code==="23503"?new Error("El empleado seleccionado no existe en el sistema"):o.code==="42501"?new Error("No tiene permisos para crear evaluaciones"):o.code==="23514"?new Error("Los valores de calificaci\xF3n deben estar entre 1 y 5"):new Error(o.message||"Error desconocido al crear la evaluaci\xF3n")}})}getDefaultObraId(){return i(this,null,function*(){try{let{data:e,error:o}=yield this.supabase.from("obras").select("id").limit(1);return o?(console.warn("Error obteniendo obras:",o),"00000000-0000-0000-0000-000000000000"):e&&e.length>0?e[0].id:"00000000-0000-0000-0000-000000000000"}catch(e){return console.warn("Error en getDefaultObraId:",e),"00000000-0000-0000-0000-000000000000"}})}calcularPuntuacionTotal(e){let o=["conocimiento_tecnico","calidad_trabajo","productividad","seguridad_laboral","trabajo_equipo","comunicacion","liderazgo","adaptabilidad","puntualidad","iniciativa","compromiso","resolucion_problemas"],r=0,a=0;return o.forEach(t=>{let n=e[t];n&&n>0&&(r+=n,a++)}),a>0?r/a:0}determinarCalificacionGeneral(e){return e>=4.5?"excelente":e>=4?"muy-bueno":e>=3.5?"bueno":e>=3?"regular":"deficiente"}getEmpleadosParaEvaluar(){return i(this,null,function*(){try{let{data:e,error:o}=yield this.supabase.from("users").select("id, nombre, email, rol").eq("activo",!0).order("nombre");return!o&&e&&e.length>0?e.map(r=>({id:r.id,nombre:r.nombre||r.email,puesto:r.rol||"Empleado",departamento:this.getDepartamentoPorRol(r.rol),fecha_ingreso:"2023-01-01",activo:!0})):[{id:"4fb82129-7475-4b55-ac52-8a712baa409b",nombre:"Juan P\xE9rez",puesto:"Operario",departamento:"Construcci\xF3n",fecha_ingreso:"2023-01-15",activo:!0},{id:"a1b2c3d4-e5f6-7890-abcd-ef1234567890",nombre:"Mar\xEDa Garc\xEDa",puesto:"Supervisora",departamento:"Calidad",fecha_ingreso:"2022-03-10",activo:!0},{id:"b2c3d4e5-f678-9012-bcde-f23456789012",nombre:"Carlos L\xF3pez",puesto:"Ingeniero",departamento:"Proyectos",fecha_ingreso:"2021-06-20",activo:!0},{id:"c3d4e5f6-a7b8-9012-cdef-345678901234",nombre:"Ana Mart\xEDnez",puesto:"Administrativa",departamento:"Recursos Humanos",fecha_ingreso:"2023-08-05",activo:!0},{id:"d4e5f6a7-b8c9-0123-def4-456789012345",nombre:"Roberto Silva",puesto:"Operario",departamento:"Mantenimiento",fecha_ingreso:"2023-11-12",activo:!0}]}catch(e){return console.error("Error getting empleados:",e),[{id:"4fb82129-7475-4b55-ac52-8a712baa409b",nombre:"Juan P\xE9rez",puesto:"Operario",departamento:"Construcci\xF3n",fecha_ingreso:"2023-01-15",activo:!0},{id:"a1b2c3d4-e5f6-7890-abcd-ef1234567890",nombre:"Mar\xEDa Garc\xEDa",puesto:"Supervisora",departamento:"Calidad",fecha_ingreso:"2022-03-10",activo:!0}]}})}getDepartamentoPorRol(e){switch(e){case"supervisor":case"jefe_obra":return"Supervisi\xF3n";case"ingeniero":return"Ingenier\xEDa";case"trabajador":case"operario":return"Construcci\xF3n";case"residente":return"Residencia";case"admin":return"Administraci\xF3n";default:return"General"}}getResumenEvaluaciones(){return i(this,null,function*(){try{return[{empleado_id:"1",empleado_nombre:"Juan P\xE9rez",promedio_general:4.2,evaluaciones_completadas:3,ultima_evaluacion:new Date("2024-01-15"),tendencia:"mejorando"},{empleado_id:"2",empleado_nombre:"Mar\xEDa Garc\xEDa",promedio_general:4.7,evaluaciones_completadas:4,ultima_evaluacion:new Date("2024-01-20"),tendencia:"estable"},{empleado_id:"3",empleado_nombre:"Carlos L\xF3pez",promedio_general:4.1,evaluaciones_completadas:2,ultima_evaluacion:new Date("2024-01-10"),tendencia:"mejorando"}]}catch(e){throw console.error("Error getting resumen:",e),e}})}updateEvaluacion(e,o){return i(this,null,function*(){try{o.puntuacion_total||(o.puntuacion_total=this.calcularPuntuacionTotal(o)),o.puntuacion_total&&(o.calificacion_general=this.determinarCalificacionGeneral(o.puntuacion_total)),o.updated_at=new Date().toISOString();let r=this.evaluacionesSubject.value,a=r.findIndex(n=>n.id===e);if(a===-1)throw new Error("Evaluaci\xF3n no encontrada");let t=d(d({},r[a]),o);return r[a]=t,this.evaluacionesSubject.next([...r]),t}catch(r){throw console.error("Error updating evaluacion:",r),new Error(r.message||"Error al actualizar la evaluaci\xF3n")}})}deleteEvaluacion(e){return i(this,null,function*(){try{let r=this.evaluacionesSubject.value.filter(a=>a.id!==e);this.evaluacionesSubject.next(r)}catch(o){throw console.error("Error deleting evaluacion:",o),new Error(o.message||"Error al eliminar la evaluaci\xF3n")}})}getEvaluacionById(e){return i(this,null,function*(){try{return this.evaluacionesSubject.value.find(r=>r.id===e)||null}catch(o){return console.error("Error getting evaluacion by ID:",o),null}})}refresh(){return i(this,null,function*(){yield this.loadInitialData()})}getEstadisticas(){return i(this,null,function*(){try{let e=this.evaluacionesSubject.value;return{total_evaluaciones:e.length,evaluaciones_completadas:e.filter(o=>o.estado==="completada").length,evaluaciones_pendientes:e.filter(o=>o.estado==="borrador").length,promedio_general:e.reduce((o,r)=>o+r.puntuacion_total,0)/e.length||0,empleados_evaluados:new Set(e.map(o=>o.evaluado_id)).size}}catch(e){return console.error("Error getting estadisticas:",e),{}}})}static{this.\u0275fac=function(o){return new(o||c)(g(h))}}static{this.\u0275prov=_({token:c,factory:c.\u0275fac,providedIn:"root"})}}return c})();export{S as a};
