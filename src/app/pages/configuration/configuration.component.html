<div class="configuration-container">
  <!-- Header -->
  <div class="header">
    <h1>Configuración de Obra</h1>
    <p class="subtitle">Selecciona o crea un proyecto para generar el informe</p>
  </div>

  <!-- Selected Items Summary -->
  <mat-card class="summary-section">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>checklist</mat-icon>
        Partidas Seleccionadas
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="items-summary">
        <p><strong>{{selectedItems.length}}</strong> partidas seleccionadas para el informe</p>
        <div class="items-preview" *ngIf="selectedItems.length > 0">
          <div class="item-chip" *ngFor="let item of selectedItems.slice(0, 3)">
            {{item.item.id}} - {{item.item.name}}
          </div>
          <div class="more-items" *ngIf="selectedItems.length > 3">
            +{{selectedItems.length - 3}} más
          </div>
        </div>
        <div class="no-items" *ngIf="selectedItems.length === 0">
          <mat-icon>warning</mat-icon>
          <p>No hay partidas seleccionadas. <a (click)="goBack()">Volver a seleccionar</a></p>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Project Selection -->
  <mat-card class="project-section">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>business</mat-icon>
        Selección de Proyecto
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="project-selection">
        <mat-form-field class="project-select">
          <mat-label>Seleccionar Proyecto Existente</mat-label>
          <mat-select [(ngModel)]="selectedProject" (selectionChange)="onProjectChange()">
            <mat-option *ngFor="let project of projects" [value]="project">
              {{project.name}} - {{project.location}}
            </mat-option>
          </mat-select>
        </mat-form-field>
        
        <div class="loading" *ngIf="isLoadingProjects">
          <mat-spinner diameter="30"></mat-spinner>
          <span>Cargando proyectos...</span>
        </div>
      </div>

      <!-- Selected Project Details -->
      <div class="project-details" *ngIf="selectedProject">
        <h3>Detalles del Proyecto</h3>
        <div class="details-grid">
          <div class="detail-item">
            <strong>Nombre:</strong> {{selectedProject.name}}
          </div>
          <div class="detail-item">
            <strong>Ubicación:</strong> {{selectedProject.location}}
          </div>
          <div class="detail-item">
            <strong>Contratista:</strong> {{selectedProject.contractor || 'No especificado'}}
          </div>
          <div class="detail-item">
            <strong>Supervisor:</strong> {{selectedProject.supervisor || 'No especificado'}}
          </div>
          <div class="detail-item">
            <strong>Fecha de inicio:</strong> {{selectedProject.start_date | date:'dd/MM/yyyy'}}
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- New Project Form -->
  <mat-card class="new-project-section">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>add_business</mat-icon>
        Crear Nuevo Proyecto
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="new-project-form">
        <div class="form-row">
          <mat-form-field class="form-field">
            <mat-label>Nombre del Proyecto *</mat-label>
            <input matInput [(ngModel)]="newProject.name" placeholder="Ej: Edificio Residencial Los Pinos">
          </mat-form-field>
          
          <mat-form-field class="form-field">
            <mat-label>Ubicación *</mat-label>
            <input matInput [(ngModel)]="newProject.location" placeholder="Ej: Av. Principal 123, Ciudad">
          </mat-form-field>
        </div>
        
        <div class="form-row">
          <mat-form-field class="form-field">
            <mat-label>Contratista</mat-label>
            <input matInput [(ngModel)]="newProject.contractor" placeholder="Nombre del contratista">
          </mat-form-field>
          
          <mat-form-field class="form-field">
            <mat-label>Supervisor</mat-label>
            <input matInput [(ngModel)]="newProject.supervisor" placeholder="Nombre del supervisor">
          </mat-form-field>
        </div>
        
        <mat-form-field class="form-field">
          <mat-label>Fecha de Inicio</mat-label>
          <input matInput [matDatepicker]="startPicker" [(ngModel)]="newProject.start_date">
          <mat-datepicker-toggle matIconSuffix [for]="startPicker"></mat-datepicker-toggle>
          <mat-datepicker #startPicker></mat-datepicker>
        </mat-form-field>
        
        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="createNewProject()">
            <mat-icon>add</mat-icon>
            Crear Proyecto
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Reports History -->
  <mat-card class="history-section" *ngIf="selectedProject">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>history</mat-icon>
        Historial de Informes
      </mat-card-title>
    </mat-card-header>
    <mat-card-content>
      <div class="loading" *ngIf="isLoadingReports">
        <mat-spinner diameter="30"></mat-spinner>
        <span>Cargando historial...</span>
      </div>
      
      <div class="no-reports" *ngIf="!isLoadingReports && reports.length === 0">
        <mat-icon>description</mat-icon>
        <p>No hay informes previos para este proyecto</p>
      </div>
      
      <div class="reports-table" *ngIf="!isLoadingReports && reports.length > 0">
        <table mat-table [dataSource]="reports" class="mat-elevation-z2">
          <ng-container matColumnDef="report_number">
            <th mat-header-cell *matHeaderCellDef>Número</th>
            <td mat-cell *matCellDef="let report">{{report.report_number}}</td>
          </ng-container>
          
          <ng-container matColumnDef="period_start">
            <th mat-header-cell *matHeaderCellDef>Período Inicio</th>
            <td mat-cell *matCellDef="let report">{{report.period_start | date:'dd/MM/yyyy'}}</td>
          </ng-container>
          
          <ng-container matColumnDef="period_end">
            <th mat-header-cell *matHeaderCellDef>Período Fin</th>
            <td mat-cell *matCellDef="let report">{{report.period_end | date:'dd/MM/yyyy'}}</td>
          </ng-container>
          
          <ng-container matColumnDef="created_at">
            <th mat-header-cell *matHeaderCellDef>Creado</th>
            <td mat-cell *matCellDef="let report">{{report.created_at | date:'dd/MM/yyyy HH:mm'}}</td>
          </ng-container>
          
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef>Acciones</th>
            <td mat-cell *matCellDef="let report">
              <button mat-icon-button color="primary" (click)="viewReport(report)" 
                     matTooltip="Ver/Editar Informe">
                <mat-icon>visibility</mat-icon>
              </button>
              <button mat-icon-button color="warn" (click)="deleteReport(report)" 
                     matTooltip="Eliminar Informe">
                <mat-icon>delete</mat-icon>
              </button>
            </td>
          </ng-container>
          
          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
        </table>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Actions -->
  <div class="actions">
    <button mat-stroked-button (click)="goBack()">
      <mat-icon>arrow_back</mat-icon>
      Volver
    </button>
    
    <button mat-raised-button color="primary" 
           [disabled]="!canContinue()" 
           (click)="continueToGeneration()">
      <mat-icon>arrow_forward</mat-icon>
      Continuar a Generación
    </button>
  </div>
</div>