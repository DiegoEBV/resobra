<div class="max-w-7xl mx-auto p-6 min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
  
  <!-- Información del proyecto -->
  <mat-card class="project-info-card shadow-lg border-0 rounded-xl mb-6">
    
    <mat-card-content class="p-6">
      <!-- Botones de Productividad -->
      <div class="productivity-buttons border-t border-gray-200 pt-1">
        <div class="flex items-center gap-3 mb-4">
          <mat-icon class="text-bitepoint-teal text-2xl">speed</mat-icon>
          <h3 class="text-lg font-semibold text-gray-800">Herramientas</h3>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-2 gap-3">
          <button 
            mat-raised-button 
            (click)="copyPreviousReport()"
            matTooltip="Copia todas las partidas del último reporte generado"
            class="productivity-btn bg-blue-600 text-white hover:bg-blue-700 transition-colors duration-200 p-4 h-auto flex flex-col items-center gap-2"
          >
            <mat-icon class="text-2xl">content_copy</mat-icon>
            <span class="text-sm font-medium">Copiar Anterior</span>
          </button>
          
          <button 
            mat-raised-button 
            (click)="createQuickReport()"
            matTooltip="Crea un reporte rápido usando tus partidas favoritas"
            class="productivity-btn bg-green-600 text-white hover:bg-green-700 transition-colors duration-200 p-4 h-auto flex flex-col items-center gap-2"
          >
            <mat-icon class="text-2xl">flash_on</mat-icon>
            <span class="text-sm font-medium">Reporte Rápido</span>
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Controles de vista y filtros -->
  <mat-card class="mb-6 shadow-lg border-0 rounded-xl">
    <mat-card-content class="p-6">
      <div class="flex gap-4 justify-center">
        <button 
          mat-raised-button 
          [color]="!showGroupedView ? 'primary' : 'basic'"
          (click)="showGroupedView = false"
          class="px-6 py-3 rounded-lg font-medium transition-all duration-300 hover:shadow-md"
        >
          <mat-icon class="mr-2">search</mat-icon>
          Vista de Búsqueda
        </button>
        <button 
          mat-raised-button 
          [color]="showGroupedView ? 'primary' : 'basic'"
          (click)="toggleView()"
          class="px-6 py-3 rounded-lg font-medium transition-all duration-300 hover:shadow-md"
        >
          <mat-icon class="mr-2">category</mat-icon>
          Vista por Especialidades
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Sección de Favoritos -->
  <mat-card class="mb-6 shadow-lg border-0 rounded-xl" *ngIf="favoriteItems.length > 0">
    <mat-card-header class="bg-gradient-to-r from-yellow-50 to-yellow-100 border-b-2 border-yellow-400 p-4">
      <mat-card-title class="flex items-center justify-between w-full">
        <div class="flex items-center gap-3">
          <mat-icon class="text-yellow-500">star</mat-icon>
          <span class="text-xl font-semibold text-gray-800">Partidas Favoritas</span>
          <span class="bg-yellow-400 text-white px-3 py-1 rounded-full text-sm font-medium">({{ favoriteItems.length }})</span>
        </div>
        <button 
          mat-icon-button 
          (click)="toggleFavorites()"
          matTooltip="{{ showFavorites ? 'Ocultar' : 'Mostrar' }} favoritos"
          class="text-yellow-600 hover:text-yellow-700"
        >
          <mat-icon>{{ showFavorites ? 'expand_less' : 'expand_more' }}</mat-icon>
        </button>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content class="p-0" *ngIf="showFavorites">
      <mat-list class="divide-y divide-gray-100">
        <mat-list-item 
          *ngFor="let item of favoriteItems" 
          class="hover:bg-yellow-50 transition-colors duration-200 cursor-pointer p-4"
          (click)="selectItem(item)"
        >
          <div matListItemTitle class="font-semibold text-gray-900 flex items-center gap-2">
            <mat-icon class="text-yellow-500 text-lg">star</mat-icon>
            {{ item.name }}
          </div>
          <div matListItemLine *ngIf="item.description" class="text-gray-600 text-sm">{{ item.description }}</div>
          <div matListItemLine *ngIf="item.unit" class="text-sm">
            <strong class="text-bitepoint-teal">Unidad:</strong> <span class="text-gray-700">{{ item.unit }}</span>
          </div>
          <mat-icon matListItemMeta class="text-bitepoint-teal hover:text-bitepoint-teal-dark transition-colors">add_circle_outline</mat-icon>
        </mat-list-item>
      </mat-list>
    </mat-card-content>
  </mat-card>

  <!-- Filtros para vista agrupada por especialidades -->
  <div class="filter-section mb-6" *ngIf="showGroupedView">
    <div class="filter-header">
      <mat-icon>filter_list</mat-icon>
      <h4>Filtrar por especialidad:</h4>
    </div>
    <div class="filter-chips-container">
      <mat-chip-set>
        <mat-chip-option 
          [selected]="selectedSpecialtyGrouped === null"
          (click)="filterBySpecialtyGrouped(null)"
        >
          Todas
        </mat-chip-option>
        <mat-chip-option 
          *ngFor="let specialty of specialties"
          [selected]="selectedSpecialtyGrouped === specialty"
          (click)="filterBySpecialtyGrouped(specialty)"
        >
          {{ getSpecialtyDisplayName(specialty) }}
        </mat-chip-option>
      </mat-chip-set>
    </div>
  </div>

  <!-- Vista agrupada por especialidades -->
  <div class="grid gap-6" *ngIf="showGroupedView">
    <div *ngFor="let specialty of getFilteredSpecialties()">
      <mat-card class="shadow-lg border-0 rounded-xl overflow-hidden" *ngIf="getSpecialtyItemCount(specialty) > 0">
        <mat-card-header class="bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-orange-400 p-6">
          <mat-card-title class="flex items-center gap-3 text-xl font-semibold text-gray-800">
            <mat-icon class="text-orange-400">category</mat-icon>
            {{ getSpecialtyDisplayName(specialty) }}
            <span class="bg-orange-400 text-white px-3 py-1 rounded-full text-sm font-medium">({{ getSpecialtyItemCount(specialty) }})</span>
          </mat-card-title>
        </mat-card-header>
        <mat-card-content class="p-0">
          <mat-list class="divide-y divide-gray-100">
            <mat-list-item 
              *ngFor="let item of groupedItems[specialty]" 
              class="hover:bg-slate-50 transition-colors duration-200 cursor-pointer p-4"
              (click)="selectItem(item)"
            >
              <div matListItemTitle class="font-semibold text-gray-900 flex items-center gap-2">
                <mat-icon *ngIf="isFavorite(item)" class="text-yellow-500 text-lg">star</mat-icon>
                {{ item.name }}
              </div>
              <div matListItemLine *ngIf="item.description" class="text-gray-600 text-sm">{{ item.description }}</div>
              <div matListItemLine *ngIf="item.unit" class="text-sm">
                <strong class="text-bitepoint-teal">Unidad:</strong> <span class="text-gray-700">{{ item.unit }}</span>
              </div>
              <mat-icon matListItemMeta class="text-bitepoint-teal hover:text-bitepoint-teal-dark transition-colors">add_circle_outline</mat-icon>
            </mat-list-item>
          </mat-list>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Sección de búsqueda -->
  <div class="search-section" *ngIf="!showGroupedView">
    <div class="search-header">
      <mat-icon>search</mat-icon>
      <h3>Buscar Partidas</h3>
    </div>
    
    <!-- Filtros por especialidad -->
    <div class="filter-section">
      <div class="filter-header">
        <mat-icon>filter_list</mat-icon>
        <h4>Filtrar por especialidad:</h4>
      </div>
      <div class="filter-chips-container">
        <mat-chip-set>
          <mat-chip-option 
            [selected]="selectedSpecialty === null"
            (click)="filterBySpecialty(null)"
          >
            Todas
          </mat-chip-option>
          <mat-chip-option 
            *ngFor="let specialty of specialties"
            [selected]="selectedSpecialty === specialty"
            (click)="filterBySpecialty(specialty)"
          >
            {{ getSpecialtyDisplayName(specialty) }}
          </mat-chip-option>
        </mat-chip-set>
      </div>
    </div>

    <div class="search-input-container">
      <mat-form-field appearance="outline">
        <mat-label>Escriba el nombre de la partida</mat-label>
        <input 
          matInput 
          [(ngModel)]="searchTerm" 
          (input)="onSearchChange()"
          placeholder="Ej: Excavación, Concreto, etc."
        >
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>

    <!-- Spinner de carga -->
    <div class="loading-section" *ngIf="isLoading">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Buscando partidas...</p>
    </div>

    <!-- Resultados de búsqueda -->
    <div class="search-results" *ngIf="!isLoading && searchResults.length > 0">
      <mat-list>
        <mat-list-item 
          *ngFor="let item of searchResults" 
          (click)="selectItem(item)"
        >
          <div matListItemTitle class="flex items-center gap-2">
            <mat-icon *ngIf="isFavorite(item)" class="text-yellow-500 text-lg">star</mat-icon>
            {{ item.name }}
          </div>
          <div matListItemLine *ngIf="item.description">{{ item.description }}</div>
          <div matListItemLine *ngIf="item.unit">
            <strong>Unidad:</strong> {{ item.unit }}
          </div>
          <div matListItemLine *ngIf="item.specialty">
            <strong>Especialidad:</strong> {{ getSpecialtyDisplayName(item.specialty) }}
          </div>
          <mat-icon matListItemMeta>add_circle_outline</mat-icon>
        </mat-list-item>
      </mat-list>
    </div>

    <!-- Mensaje cuando no hay resultados -->
    <div class="empty-state" *ngIf="!isLoading && searchTerm && searchResults.length === 0">
      <mat-icon>search_off</mat-icon>
      <p>No se encontraron partidas que coincidan con "{{ searchTerm }}"</p>
      <p>Intente con otros términos de búsqueda.</p>
    </div>
  </div>

  <!-- Sección de partidas seleccionadas -->
  <mat-card class="shadow-lg border-0 rounded-xl">
    <mat-card-header class="bg-gradient-to-r from-slate-50 to-slate-100 border-b border-gray-200 p-6">
      <mat-card-title class="flex items-center justify-between w-full">
        <div class="flex items-center gap-3 flex-1">
          <mat-icon class="text-bitepoint-teal">playlist_add_check</mat-icon>
          <span class="text-2xl font-semibold text-gray-800">Partidas Seleccionadas</span>
          <span class="bg-bitepoint-teal text-white px-3 py-1 rounded-full text-sm font-medium">({{ selectedItems.length }})</span>
        </div>
        <div class="flex-shrink-0 ml-4">
          <button 
            mat-raised-button 
            *ngIf="selectedItems.length > 0"
            (click)="clearAllItems()"
            matTooltip="Limpiar todas las partidas seleccionadas"
            class="bg-gray-600 text-white hover:bg-gray-700 transition-colors duration-200 font-medium whitespace-nowrap"
          >
            <mat-icon class="mr-2">clear_all</mat-icon>
            Limpiar Todo
          </button>
        </div>
      </mat-card-title>
    </mat-card-header>
    <mat-card-content class="p-6">
      <!-- Lista vacía -->
      <div class="text-center py-12" *ngIf="selectedItems.length === 0">
        <mat-icon class="text-gray-400 text-6xl mb-4">inbox</mat-icon>
        <p class="text-gray-600 text-lg mb-2">No hay partidas seleccionadas</p>
        <p class="text-gray-500">Use la búsqueda o vista agrupada para agregar partidas.</p>
      </div>

      <!-- Lista de partidas seleccionadas -->
      <div class="space-y-4" *ngIf="selectedItems.length > 0">
        <div *ngFor="let selectedItem of selectedItems; let i = index">
          <mat-card class="shadow-md border border-gray-200 rounded-lg overflow-hidden hover:shadow-lg transition-shadow duration-200">
            <mat-card-header class="bg-gray-50 border-b border-gray-200 p-4">
              <mat-card-title class="text-lg font-semibold text-gray-900">{{ selectedItem.item.name }}</mat-card-title>
              <mat-card-subtitle *ngIf="selectedItem.item.description" class="text-gray-600 mt-1">{{ selectedItem.item.description }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content class="p-4">
              <div class="mb-4">
                <p *ngIf="selectedItem.item.unit" class="text-sm mb-1"><strong class="text-bitepoint-teal">Unidad:</strong> <span class="text-gray-700">{{ selectedItem.item.unit }}</span></p>
                <p *ngIf="selectedItem.item.specialty" class="text-sm"><strong class="text-bitepoint-teal">Especialidad:</strong> <span class="text-gray-700">{{ getSpecialtyDisplayName(selectedItem.item.specialty) }}</span></p>
              </div>

              <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Metrado</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    [value]="selectedItem.metrado"
                    readonly
                    class="text-center font-medium bg-gray-50"
                    placeholder="0.00"
                  >
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Anterior</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    [(ngModel)]="selectedItem.previousQuantity"
                    (ngModelChange)="updateQuantity(i, 'previousQuantity', $event)"
                    min="0"
                    step="0.01"
                    class="text-center font-medium"
                  >
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Actual</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    [(ngModel)]="selectedItem.currentQuantity"
                    (ngModelChange)="updateQuantity(i, 'currentQuantity', $event)"
                    min="0"
                    step="0.01"
                    class="text-center font-medium"
                  >
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Acumulado</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    [value]="selectedItem.previousQuantity + selectedItem.currentQuantity"
                    readonly
                    class="text-center font-bold text-bitepoint-teal bg-bitepoint-teal-50"
                  >
                </mat-form-field>

                <mat-form-field appearance="outline" class="w-full">
                  <mat-label>Saldo</mat-label>
                  <input 
                    matInput 
                    type="number" 
                    [value]="getSaldo(selectedItem)"
                    readonly
                    class="text-center font-bold text-orange-600 bg-orange-50"
                  >
                </mat-form-field>
              </div>

              <div class="flex justify-end gap-2 mt-4 pt-4 border-t border-gray-200">
                <button 
                  mat-icon-button 
                  (click)="editSelectedItem(i)"
                  matTooltip="Editar partida"
                  class="text-bitepoint-teal hover:text-bitepoint-teal-dark hover:bg-bitepoint-teal-50 transition-colors duration-200"
                >
                  <mat-icon>edit</mat-icon>
                </button>
                <button 
                  mat-icon-button 
                  (click)="removeSelectedItem(i)"
                  matTooltip="Eliminar partida"
                  class="text-red-600 hover:text-red-800 hover:bg-red-50 transition-colors duration-200"
                >
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Botón para continuar -->
  <div class="actions" *ngIf="selectedItems.length > 0">
    <button 
      mat-raised-button 
      color="primary" 
      size="large"
      (click)="proceedToConfiguration()"
    >
      <mat-icon>arrow_forward</mat-icon>
      Continuar a Configuración
     </button>
   </div>
 </div>
 
