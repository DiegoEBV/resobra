<div class="frente-edit-container">
  <mat-card class="frente-edit-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>edit_location</mat-icon>
        Editar Frente
      </mat-card-title>
      <mat-card-subtitle *ngIf="frente">
        Modificando: {{ frente.nombre }}
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="frenteForm" (ngSubmit)="onSubmit()" class="frente-form">
        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Nombre del Frente</mat-label>
            <input matInput formControlName="nombre" placeholder="Ej: Frente Norte">
            <mat-icon matSuffix>label</mat-icon>
            <mat-error *ngIf="frenteForm.get('nombre')?.invalid && frenteForm.get('nombre')?.touched">
              {{ getErrorMessage('nombre') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Descripción</mat-label>
            <textarea matInput formControlName="descripcion" rows="3" 
                      placeholder="Descripción detallada del frente de trabajo"></textarea>
            <mat-icon matSuffix>description</mat-icon>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Obra</mat-label>
            <mat-select formControlName="obra_id">
              <mat-option *ngFor="let obra of obras" [value]="obra.id">
                {{ obra.nombre }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>business</mat-icon>
            <mat-error *ngIf="frenteForm.get('obra_id')?.invalid && frenteForm.get('obra_id')?.touched">
              {{ getErrorMessage('obra_id') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Estado</mat-label>
            <mat-select formControlName="estado">
              <mat-option *ngFor="let estado of estadosFrente" [value]="estado.value">
                {{ estado.label }}
              </mat-option>
            </mat-select>
            <mat-icon matSuffix>flag</mat-icon>
            <mat-error *ngIf="frenteForm.get('estado')?.invalid && frenteForm.get('estado')?.touched">
              {{ getErrorMessage('estado') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Fecha de Inicio</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="fecha_inicio">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
            <mat-error *ngIf="frenteForm.get('fecha_inicio')?.invalid && frenteForm.get('fecha_inicio')?.touched">
              {{ getErrorMessage('fecha_inicio') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Fecha Fin Estimada</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="fecha_fin_estimada">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Latitud</mat-label>
            <input matInput type="number" formControlName="ubicacion_lat" 
                   placeholder="Ej: 4.5709" step="0.000001">
            <mat-icon matSuffix>place</mat-icon>
            <mat-error *ngIf="frenteForm.get('ubicacion_lat')?.invalid && frenteForm.get('ubicacion_lat')?.touched">
              {{ getErrorMessage('ubicacion_lat') }}
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline" class="half-width">
            <mat-label>Longitud</mat-label>
            <input matInput type="number" formControlName="ubicacion_lng" 
                   placeholder="Ej: -74.2973" step="0.000001">
            <mat-icon matSuffix>place</mat-icon>
            <mat-error *ngIf="frenteForm.get('ubicacion_lng')?.invalid && frenteForm.get('ubicacion_lng')?.touched">
              {{ getErrorMessage('ubicacion_lng') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Progreso General (%)</mat-label>
            <input matInput type="number" formControlName="progreso_general" 
                   placeholder="0-100" min="0" max="100">
            <mat-icon matSuffix>trending_up</mat-icon>
            <mat-error *ngIf="frenteForm.get('progreso_general')?.invalid && frenteForm.get('progreso_general')?.touched">
              {{ getErrorMessage('progreso_general') }}
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>straighten</mat-icon>
            Información Kilométrica
          </h3>
          
          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Kilómetro Inicial</mat-label>
              <input matInput type="number" formControlName="km_inicial" 
                     placeholder="Ej: 0.0" step="0.1" min="0">
              <mat-icon matSuffix>start</mat-icon>
              <mat-error *ngIf="frenteForm.get('km_inicial')?.invalid && frenteForm.get('km_inicial')?.touched">
                {{ getErrorMessage('km_inicial') }}
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Kilómetro Final</mat-label>
              <input matInput type="number" formControlName="km_final" 
                     placeholder="Ej: 5.0" step="0.1" min="0">
              <mat-icon matSuffix>flag</mat-icon>
              <mat-error *ngIf="frenteForm.get('km_final')?.invalid && frenteForm.get('km_final')?.touched">
                {{ getErrorMessage('km_final') }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Coordenadas de Inicio -->
          <div class="form-row" formGroupName="coordenadas_inicio">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Latitud Inicio</mat-label>
              <input matInput type="number" formControlName="lat" 
                     placeholder="Ej: -16.5" step="0.000001">
              <mat-icon matSuffix>my_location</mat-icon>
              <mat-error *ngIf="frenteForm.get('coordenadas_inicio.lat')?.invalid && frenteForm.get('coordenadas_inicio.lat')?.touched">
                Latitud de inicio es requerida
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Longitud Inicio</mat-label>
              <input matInput type="number" formControlName="lng" 
                     placeholder="Ej: -68.15" step="0.000001">
              <mat-icon matSuffix>my_location</mat-icon>
              <mat-error *ngIf="frenteForm.get('coordenadas_inicio.lng')?.invalid && frenteForm.get('coordenadas_inicio.lng')?.touched">
                Longitud de inicio es requerida
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Coordenadas de Fin -->
          <div class="form-row" formGroupName="coordenadas_fin">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Latitud Fin</mat-label>
              <input matInput type="number" formControlName="lat" 
                     placeholder="Ej: -16.5" step="0.000001">
              <mat-icon matSuffix>location_on</mat-icon>
              <mat-error *ngIf="frenteForm.get('coordenadas_fin.lat')?.invalid && frenteForm.get('coordenadas_fin.lat')?.touched">
                Latitud de fin es requerida
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Longitud Fin</mat-label>
              <input matInput type="number" formControlName="lng" 
                     placeholder="Ej: -68.15" step="0.000001">
              <mat-icon matSuffix>location_on</mat-icon>
              <mat-error *ngIf="frenteForm.get('coordenadas_fin.lng')?.invalid && frenteForm.get('coordenadas_fin.lng')?.touched">
                Longitud de fin es requerida
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Sección del Mapa Interactivo -->
        <div class="form-section">
          <h3 class="section-title">
            <mat-icon>map</mat-icon>
            Definir Ruta en Mapa
            <button mat-icon-button type="button" (click)="clearMap()" 
                    matTooltip="Limpiar mapa" class="clear-map-btn">
              <mat-icon>clear</mat-icon>
            </button>
          </h3>
          
          <div class="map-instructions">
            <p><strong>Instrucciones:</strong></p>
            <ol>
              <li>Haz clic en el mapa para establecer el <strong>punto de inicio</strong></li>
              <li>Haz clic nuevamente para establecer el <strong>punto final</strong></li>
              <li>Continúa haciendo clic para agregar <strong>puntos intermedios</strong> (curvas)</li>
            </ol>
          </div>

          <div class="map-container" #mapContainer></div>
        </div>

        <!-- Puntos Intermedios -->
        <div class="form-section" *ngIf="coordenadasIntermedias.length > 0">
          <h3 class="section-title">
            <mat-icon>timeline</mat-icon>
            Puntos de Control Intermedios ({{ coordenadasIntermedias.length }})
          </h3>
          
          <mat-expansion-panel class="intermediate-points-panel">
            <mat-expansion-panel-header>
              <mat-panel-title>
                <mat-icon>control_point</mat-icon>
                Gestionar Puntos Intermedios
              </mat-panel-title>
              <mat-panel-description>
                Editar kilometraje y coordenadas de los puntos de control
              </mat-panel-description>
            </mat-expansion-panel-header>

            <div formArrayName="coordenadas_intermedias">
              <mat-list>
                <mat-list-item *ngFor="let point of coordenadasIntermedias.controls; let i = index" 
                               [formGroupName]="i" class="intermediate-point-item">
                  <mat-icon matListIcon>place</mat-icon>
                  
                  <div class="point-details">
                    <div class="point-coordinates">
                      <mat-form-field appearance="outline" class="coord-field">
                        <mat-label>Latitud</mat-label>
                        <input matInput type="number" formControlName="lat" step="0.000001" readonly>
                      </mat-form-field>
                      
                      <mat-form-field appearance="outline" class="coord-field">
                        <mat-label>Longitud</mat-label>
                        <input matInput type="number" formControlName="lng" step="0.000001" readonly>
                      </mat-form-field>
                      
                      <mat-form-field appearance="outline" class="km-field">
                        <mat-label>Kilometraje</mat-label>
                        <input matInput type="number" formControlName="kilometraje" 
                               step="0.1" min="0" placeholder="Km">
                        <mat-error *ngIf="point.get('kilometraje')?.invalid && point.get('kilometraje')?.touched">
                          Kilometraje es requerido
                        </mat-error>
                      </mat-form-field>
                    </div>
                  </div>
                  
                  <button mat-icon-button type="button" (click)="removeIntermediatePoint(i)" 
                          matTooltip="Eliminar punto" class="remove-point-btn">
                    <mat-icon>delete</mat-icon>
                  </button>
                </mat-list-item>
              </mat-list>
            </div>
          </mat-expansion-panel>
        </div>
      </form>
    </mat-card-content>

    <mat-card-actions align="end">
      <button mat-button type="button" (click)="onCancel()" [disabled]="isLoading">
        <mat-icon>cancel</mat-icon>
        Cancelar
      </button>
      <button mat-raised-button color="primary" (click)="onSubmit()" 
              [disabled]="isLoading || frenteForm.invalid">
        <mat-icon>save</mat-icon>
        {{ isLoading ? 'Guardando...' : 'Actualizar Frente' }}
      </button>
    </mat-card-actions>
  </mat-card>
</div>