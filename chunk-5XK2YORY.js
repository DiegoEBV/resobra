import{a as A}from"./chunk-GOBT7UBB.js";import{a as K}from"./chunk-WFXXN3GR.js";import{ba as k,g as w,ga as _}from"./chunk-B6672ACT.js";import{a as m,b as I,i as u}from"./chunk-ODN5LVDJ.js";var U=(()=>{class v{constructor(e,i){this.supabase=e,this.directAuthService=i,this.kpisSubject=new w([]),this.kpis$=this.kpisSubject.asObservable(),this.dashboardKPIsSubject=new w(null),this.dashboardKPIs$=this.dashboardKPIsSubject.asObservable(),this.alertasSubject=new w([]),this.alertas$=this.alertasSubject.asObservable(),this.isInitialized=!1}initialize(){return u(this,null,function*(){try{console.log("\u{1F504} KpisService - Iniciando carga de datos...");let e=this.directAuthService.getCurrentUser();if(!e){console.log("\u274C No hay usuario autenticado - no se pueden cargar KPIs");return}console.log("\u2705 Usuario autenticado para inicializaci\xF3n:",e.id);let i=this.directAuthService.getAccessToken();i&&(yield this.supabase.setSession(i),console.log("\u2705 Sesi\xF3n global configurada")),yield Promise.all([this.loadUserKPIs(),this.loadDashboardKPIs(),this.loadAlertas()]),this.isInitialized=!0,console.log("\u2705 Inicializaci\xF3n completada")}catch(e){throw console.error("\u274C Error en inicializaci\xF3n:",e),e}})}isServiceInitialized(){return this.isInitialized}loadUserKPIs(){return u(this,null,function*(){try{console.log("\u{1F504} KpisService - Cargando KPIs del usuario...");let e=this.directAuthService.getCurrentUser();if(!e){console.error("\u274C Usuario no autenticado");return}console.log("\u2705 Usuario autenticado:",e.id);let i=this.directAuthService.getAccessToken();if(!i)throw new Error("Token de autenticaci\xF3n no disponible");yield this.supabase.setSession(i),console.log("\u2705 Sesi\xF3n configurada para carga de KPIs");let{data:a,error:t}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",e.id);if(t)throw new Error(`Error obteniendo obras: ${t.message}`);if(!a||a.length===0){this.kpisSubject.next([]);return}let o=a.map(d=>d.obra_id),{data:r,error:s}=yield this.supabase.client.from("kpis").select(`
          *,
          obra:obras(nombre)
        `).in("obra_id",o).is("actividad_id",null);if(s)throw new Error(`Error cargando KPIs de obra: ${s.message}`);let{data:c,error:n}=yield this.supabase.client.from("actividades").select("id").in("obra_id",o),l=[];if(!n&&c&&c.length>0){let d=c.map(p=>p.id),{data:h,error:b}=yield this.supabase.client.from("kpis").select(`
            *,
            actividad:actividades(tipo_actividad, ubicacion)
          `).in("actividad_id",d);if(b)throw new Error(`Error cargando KPIs de actividad: ${b.message}`);l=h||[]}let f=[...r||[],...l].filter((d,h,b)=>h===b.findIndex(p=>p.id===d.id));this.kpisSubject.next(f)}catch(e){throw this.kpisSubject.next([]),e}})}loadDashboardKPIs(){return u(this,null,function*(){try{console.log("\u{1F504} KpisService - Cargando KPIs para dashboard...");let e=yield this.directAuthService.getCurrentUser();if(!e){console.log("\u274C No hay usuario autenticado para cargar dashboard KPIs");return}console.log("\u2705 Usuario autenticado para dashboard:",e.id);let i=this.directAuthService.getAccessToken();if(!i)throw console.error("\u274C Token de autenticaci\xF3n no disponible"),new Error("Token de autenticaci\xF3n no disponible");yield this.supabase.setSession(i),console.log("\u2705 Sesi\xF3n configurada para dashboard KPIs");let{data:a,error:t}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",e.id);if(t)throw new Error(`Error obteniendo obras: ${t.message}`);if(!a||a.length===0){this.dashboardKPIsSubject.next({rendimiento:{promedio:0,tendencia:"estable",criticos:0},calidad:{promedio:0,tendencia:"estable",criticos:0},seguridad:{promedio:0,tendencia:"estable",criticos:0},costo:{promedio:0,tendencia:"estable",criticos:0},tiempo:{promedio:0,tendencia:"estable",criticos:0}});return}let o=a.map(p=>p.obra_id),r=new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0],{data:s,error:c}=yield this.supabase.client.from("kpis").select("avance_fisico, productividad, calidad, desviacion_cronograma").in("obra_id",o).gte("fecha",r);if(c)throw new Error(`Error cargando KPIs de obras: ${c.message}`);let{data:n,error:l}=yield this.supabase.client.from("actividades").select("id").in("obra_id",o);if(l)throw new Error(`Error cargando actividades: ${l.message}`);let g=[];if(n&&n.length>0){let p=n.map(E=>E.id),{data:P,error:S}=yield this.supabase.client.from("kpis").select("avance_fisico, productividad, calidad, desviacion_cronograma").in("actividad_id",p).gte("fecha",r);if(S)throw new Error(`Error cargando KPIs de actividades: ${S.message}`);g=P||[]}let f=s||[],d=g||[],h=[...f,...d],b=this.processDashboardKPIs(h);this.dashboardKPIsSubject.next(b)}catch(e){throw this.dashboardKPIsSubject.next({rendimiento:{promedio:0,tendencia:"estable",criticos:0},calidad:{promedio:0,tendencia:"estable",criticos:0},seguridad:{promedio:0,tendencia:"estable",criticos:0},costo:{promedio:0,tendencia:"estable",criticos:0},tiempo:{promedio:0,tendencia:"estable",criticos:0}}),e}})}processDashboardKPIs(e){let i={};if(e.length>0){let a=e.reduce((s,c)=>s+(c.avance_fisico||0),0)/e.length,t=e.reduce((s,c)=>s+(c.productividad||0),0)/e.length,o=e.reduce((s,c)=>s+(c.calidad||0),0)/e.length,r="estable";i.rendimiento={promedio:Math.round(a),tendencia:r,criticos:e.filter(s=>(s.avance_fisico||0)<50).length},i.calidad={promedio:Math.round(o),tendencia:r,criticos:e.filter(s=>(s.calidad||0)<70).length},i.seguridad={promedio:85,tendencia:r,criticos:0},i.costo={promedio:80,tendencia:r,criticos:0},i.tiempo={promedio:Math.round(100-Math.abs(e.reduce((s,c)=>s+(c.desviacion_cronograma||0),0)/e.length)),tendencia:r,criticos:e.filter(s=>Math.abs(s.desviacion_cronograma||0)>10).length}}else i.rendimiento={promedio:0,tendencia:"estable",criticos:0},i.calidad={promedio:0,tendencia:"estable",criticos:0},i.seguridad={promedio:0,tendencia:"estable",criticos:0},i.costo={promedio:0,tendencia:"estable",criticos:0},i.tiempo={promedio:0,tendencia:"estable",criticos:0};return i}loadAlertas(){return u(this,null,function*(){try{console.log("\u{1F504} KpisService - Cargando alertas...");let e=yield this.directAuthService.getCurrentUser();if(!e){console.log("\u274C No hay usuario autenticado para cargar alertas");return}console.log("\u2705 Usuario autenticado para alertas:",e.id);let i=this.directAuthService.getAccessToken();if(!i)throw console.error("\u274C Token de autenticaci\xF3n no disponible"),new Error("Token de autenticaci\xF3n no disponible");yield this.supabase.setSession(i),console.log("\u2705 Sesi\xF3n configurada para alertas");let{data:a,error:t}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",e.id);if(t)throw new Error(`Error obteniendo obras para alertas: ${t.message}`);if(!a||a.length===0){this.alertasSubject.next([]);return}let o=a.map(d=>d.obra_id),{data:r,error:s}=yield this.supabase.client.from("kpis").select(`
          id,
          avance_fisico,
          productividad,
          calidad,
          fecha,
          obra:obras(nombre)
        `).in("obra_id",o).order("fecha",{ascending:!1}).limit(5);if(s)throw new Error(`Error cargando KPIs de obras para alertas: ${s.message}`);let{data:c,error:n}=yield this.supabase.client.from("actividades").select("id").in("obra_id",o),l=[];if(!n&&c&&c.length>0){let d=c.map(p=>p.id),{data:h,error:b}=yield this.supabase.client.from("kpis").select(`
            id,
            avance_fisico,
            productividad,
            calidad,
            fecha,
            actividad:actividades(tipo_actividad, ubicacion)
          `).in("actividad_id",d).order("fecha",{ascending:!1}).limit(5);b||(l=h||[])}let f=[...r||[],...l].map(d=>({id:d.id,avance_fisico:d.avance_fisico,productividad:d.productividad,calidad:d.calidad,fecha:d.fecha,obra_nombre:d.obra?.nombre||"Sin asignar",actividad_tipo:d.actividad?.tipo_actividad||null,actividad_ubicacion:d.actividad?.ubicacion||null}));this.alertasSubject.next(f.slice(0,10))}catch(e){throw this.alertasSubject.next([]),e}})}createKPI(e){return u(this,null,function*(){try{console.log("\u{1F504} KpisService - Iniciando creaci\xF3n de KPI...");let i=this.directAuthService.getCurrentUser();if(!i)throw console.error("\u274C Usuario no autenticado"),new Error("Usuario no autenticado");console.log("\u2705 Usuario autenticado:",i.id);let a=this.directAuthService.getAccessToken();if(!a)throw console.error("\u274C Token de autenticaci\xF3n no disponible"),new Error("Token de autenticaci\xF3n no disponible");console.log("\u2705 Token disponible:",a.substring(0,20)+"..."),console.log("\u{1F527} Configurando sesi\xF3n en cliente Supabase..."),yield this.supabase.setSession(a),console.log("\u2705 Sesi\xF3n configurada");let t=I(m({},e),{calculated_at:new Date().toISOString(),created_by:i.id});console.log("\u{1F4E4} Enviando datos KPI:",t);let{data:o,error:r}=yield this.supabase.client.from("kpis").insert([t]).select(`
          *,
          obra:obras(id, nombre),
          actividad:actividades(id, tipo_actividad, ubicacion, responsable)
        `).single();if(r)throw console.error("\u274C Error en inserci\xF3n:",r),r;return console.log("\u2705 KPI creado exitosamente:",o),yield this.refresh(),o}catch(i){throw console.error("\u274C Error creating KPI:",i),i}})}updateKPI(e,i){return u(this,null,function*(){try{console.log("\u{1F504} KpisService - Actualizando KPI:",e);let a=this.directAuthService.getAccessToken();if(!a)throw console.error("\u274C Token de autenticaci\xF3n no disponible"),new Error("Token de autenticaci\xF3n no disponible");yield this.supabase.setSession(a);let t=I(m({},i),{updated_at:new Date().toISOString()});console.log("\u{1F4E4} Actualizando con datos:",t);let{data:o,error:r}=yield this.supabase.client.from("kpis").update(t).eq("id",e).select(`
          *,
          obra:obras(id, nombre),
          actividad:actividades(id, tipo_actividad, ubicacion, responsable)
        `).single();if(r)throw console.error("\u274C Error actualizando KPI:",r),r;return console.log("\u2705 KPI actualizado exitosamente:",o),i.avance_fisico!==void 0&&(yield this.addKPIHistorial(e,i.avance_fisico,"Avance f\xEDsico actualizado")),yield this.refresh(),o}catch(a){throw a}})}deleteKPI(e){return u(this,null,function*(){try{if(console.log("\u{1F504} KpisService - Eliminando KPI:",e),!e||typeof e!="string"||e.trim()==="")throw console.error("\u274C ID de KPI inv\xE1lido o vac\xEDo"),new Error("ID de KPI inv\xE1lido o vac\xEDo");let i=this.directAuthService.getAccessToken();if(!i)throw console.error("\u274C Token de autenticaci\xF3n no disponible"),new Error("Token de autenticaci\xF3n no disponible");yield this.supabase.setSession(i);let{data:a,error:t}=yield this.supabase.client.from("kpis").select("id, obra_id, actividad_id, created_by").eq("id",e.trim()).single();if(t)throw console.error("\u274C Error verificando KPI:",t),t.code==="PGRST116"?new Error("KPI no encontrado - puede haber sido eliminado previamente"):new Error(`No se pudo verificar el KPI: ${t.message}`);if(!a)throw console.error("\u274C El KPI no existe o ya fue eliminado"),new Error("El KPI no existe o ya fue eliminado");console.log("\u2705 KPI encontrado:",a.id);let o=yield this.directAuthService.getCurrentUser();if(!o)throw console.error("\u274C Usuario no autenticado"),new Error("Usuario no autenticado");console.log("\u2705 Usuario autenticado:",o.id);let{error:r}=yield this.supabase.client.from("kpis").delete().eq("id",e.trim());if(r)throw console.error("\u274C Error en eliminaci\xF3n:",r),r.code==="42501"?new Error("No tiene permisos para eliminar este KPI"):new Error(`Error al eliminar KPI: ${r.message}`);console.log("\u2705 KPI eliminado exitosamente"),yield this.refresh()}catch(i){throw console.error("\u274C Error deleting KPI:",i),i}})}addKPIHistorial(e,i,a){return u(this,null,function*(){try{if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let o={kpi_id:e,valor:i,fecha_registro:new Date().toISOString(),observaciones:a},{error:r}=yield this.supabase.client.from("kpi_historial").insert([o]);if(r)throw r}catch{}})}getKPIHistorial(e,i=30){return u(this,null,function*(){try{if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let{data:t,error:o}=yield this.supabase.client.from("kpi_historial").select("*").eq("kpi_id",e).order("fecha_registro",{ascending:!1}).limit(i);if(o)throw o;return t||[]}catch{return[]}})}getKPIsByTipo(e){return u(this,null,function*(){try{let i=yield this.directAuthService.getCurrentUser();if(!i)return[];if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let{data:t,error:o}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",i.id);if(o)throw o;if(t&&t.length>0){let r=t.map(n=>n.obra_id),{data:s,error:c}=yield this.supabase.client.from("kpis").select(`
            *,
            obra:obras(id, nombre),
            actividad:actividades(id, tipo_actividad, ubicacion, responsable)
          `).in("obra_id",r).order("fecha",{ascending:!1});if(c)throw c;return s||[]}return[]}catch{return[]}})}getEstadisticasGenerales(){return u(this,null,function*(){try{let e=yield this.directAuthService.getCurrentUser();if(!e)return null;if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let{data:a,error:t}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",e.id);if(t)throw t;if(a&&a.length>0){let o=a.map(n=>n.obra_id),{data:r,error:s}=yield this.supabase.client.from("kpis").select("avance_fisico, productividad, calidad, desviacion_cronograma").in("obra_id",o);if(s)throw s;return{total:r?.length||0,avance_fisico_promedio:r?.length?r.reduce((n,l)=>n+(l.avance_fisico||0),0)/r.length:0,productividad_promedio:r?.length?r.reduce((n,l)=>n+(l.productividad||0),0)/r.length:0,calidad_promedio:r?.length?r.reduce((n,l)=>n+(l.calidad||0),0)/r.length:0,desviacion_cronograma_promedio:r?.length?r.reduce((n,l)=>n+(l.desviacion_cronograma||0),0)/r.length:0}}return null}catch{return null}})}calculateAutomaticKPIs(e){return u(this,null,function*(){try{if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let{data:a,error:t}=yield this.supabase.client.from("actividades").select("*").eq("obra_id",e);if(t)throw t;if(a&&a.length>0){let o=a.filter(h=>h.estado==="finalizado").length,r=a.length,s=r>0?Math.round(o/r*100):0,c=a.reduce((h,b)=>h+(b.progreso_porcentaje||0),0)/r,n=Math.round(c),l=Math.min(100,Math.max(70,n+Math.random()*20-10)),g=new Date().toISOString().split("T")[0],{data:f}=yield this.supabase.client.from("kpis").select("id").eq("obra_id",e).gte("fecha",g).lt("fecha",`${g}T23:59:59`).single(),d={obra_id:e,fecha:new Date().toISOString(),avance_fisico:s,productividad:n,calidad:Math.round(l),desviacion_cronograma:0,calculated_at:new Date().toISOString()};f?yield this.updateKPI(f.id,d):yield this.createKPI(d)}}catch{}})}calculateAllAutomaticKPIs(){return u(this,null,function*(){try{let e=yield this.directAuthService.getCurrentUser();if(!e)return;if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let{data:a,error:t}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",e.id);if(t)throw t;if(a&&a.length>0){for(let o of a)yield this.calculateAutomaticKPIs(o.obra_id);yield this.refresh()}}catch{}})}getActividadesByObra(e){return u(this,null,function*(){try{if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let{data:a,error:t}=yield this.supabase.client.from("actividades").select("id, tipo_actividad, ubicacion, responsable, estado").eq("obra_id",e).order("fecha",{ascending:!1});if(t)throw t;return a||[]}catch{return[]}})}getKPIsByActividad(e){return u(this,null,function*(){try{if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let{data:a,error:t}=yield this.supabase.client.from("kpis").select(`
          *,
          obra:obras(id, nombre),
          actividad:actividades(id, tipo_actividad, ubicacion, responsable)
        `).eq("actividad_id",e).order("fecha",{ascending:!1});if(t)throw t;return a||[]}catch{return[]}})}calculateAutomaticKPIsForActividad(e){return u(this,null,function*(){try{if(!this.directAuthService.getAccessToken())throw new Error("Token de autenticaci\xF3n no disponible");let{data:a,error:t}=yield this.supabase.client.from("actividades").select("*").eq("id",e).single();if(t)throw t;if(a){let o=a.progreso_porcentaje||0,r=this.calculateProductividadFromActividad(a),s=this.calculateCalidadFromActividad(a),c=new Date().toISOString().split("T")[0],{data:n}=yield this.supabase.client.from("kpis").select("id").eq("actividad_id",e).gte("fecha",c).lt("fecha",`${c}T23:59:59`).single(),l={actividad_id:e,fecha:new Date().toISOString(),avance_fisico:o,productividad:r,calidad:s,desviacion_cronograma:this.calculateDesviacionFromActividad(a),calculated_at:new Date().toISOString()};n?yield this.updateKPI(n.id,l):yield this.createKPI(l)}}catch{}})}calculateProductividadFromActividad(e){let i=e.progreso_porcentaje||0,a=e.estado==="finalizado"?1.1:.9;return Math.min(100,Math.round(i*a))}calculateCalidadFromActividad(e){let a=e.estado==="finalizado"?1.2:1;return Math.min(100,Math.round(80*a))}calculateDesviacionFromActividad(e){return 0}refresh(){return u(this,null,function*(){try{if(console.log("\u{1F504} Iniciando refresh de datos KPI"),!(yield this.directAuthService.getCurrentUser())){console.error("\u274C Usuario no autenticado para refresh");return}let i=this.directAuthService.getAccessToken();if(!i){console.error("\u274C Token no disponible para refresh");return}console.log("\u{1F510} Configurando sesi\xF3n Supabase para refresh"),yield this.supabase.setSession(i),yield Promise.all([this.loadUserKPIs(),this.loadDashboardKPIs(),this.loadAlertas()]),console.log("\u2705 Refresh de datos KPI completado")}catch(e){throw console.error("\u274C Error en refresh de datos KPI:",e),e}})}static{this.\u0275fac=function(i){return new(i||v)(_(K),_(A))}}static{this.\u0275prov=k({token:v,factory:v.\u0275fac,providedIn:"root"})}}return v})();export{U as a};
