import{a as m}from"./chunk-GOBT7UBB.js";import{a as U}from"./chunk-WFXXN3GR.js";import{Z as g,ba as b,f as w,g as v,ga as p}from"./chunk-B6672ACT.js";import{a as d,b as l,i}from"./chunk-ODN5LVDJ.js";var D=(()=>{class h{constructor(t,e){this.supabase=t,this.directAuthService=e,this.actividadesSubject=new v([]),this.actividades$=this.actividadesSubject.asObservable().pipe(g(a=>{})),this.frentesSubject=new v([]),this.frentes$=this.frentesSubject.asObservable().pipe(g(a=>{})),this.progresoUpdatedSubject=new w,this.progresoUpdated$=this.progresoUpdatedSubject.asObservable(),this.actividadesChannel=null,this.frentesChannel=null,this.directAuthService.getCurrentUser()&&(this.loadUserActividades().catch(a=>{}),this.loadUserFrente().catch(a=>{}),this.setupRealtimeSubscriptions())}ngOnDestroy(){this.cleanupRealtimeSubscriptions()}setupRealtimeSubscriptions(){this.cleanupRealtimeSubscriptions(),this.directAuthService.getCurrentUser()&&(this.actividadesChannel=this.supabase.client.channel("actividades-changes").on("postgres_changes",{event:"*",schema:"public",table:"actividades"},e=>{this.handleActividadChange(e)}).subscribe(),this.frentesChannel=this.supabase.client.channel("frentes-changes").on("postgres_changes",{event:"*",schema:"public",table:"frentes"},e=>{this.handleFrenteChange(e)}).subscribe())}cleanupRealtimeSubscriptions(){this.actividadesChannel&&(this.supabase.client.removeChannel(this.actividadesChannel),this.actividadesChannel=null),this.frentesChannel&&(this.supabase.client.removeChannel(this.frentesChannel),this.frentesChannel=null)}handleActividadChange(t){return i(this,null,function*(){let e=this.directAuthService.getCurrentUser();if(!e)return;(yield this.isActividadRelevantForUser(t,e.id))&&(yield this.loadUserActividades())})}handleFrenteChange(t){return i(this,null,function*(){let e=this.directAuthService.getCurrentUser();if(!e)return;(yield this.isFrenteRelevantForUser(t,e.id))&&(yield this.loadUserFrente())})}isActividadRelevantForUser(t,e){return i(this,null,function*(){try{return!!(t.new||t.old)}catch{return!1}})}isFrenteRelevantForUser(t,e){return i(this,null,function*(){try{return!!(t.new||t.old)}catch{return!1}})}loadUserActividades(){return i(this,null,function*(){try{if(!this.directAuthService.getCurrentUser())return;let e,r,a=yield this.supabase.client.from("actividades").select("*").limit(10),s=yield this.supabase.client.from("actividades").select(`
          *,
          frente:frentes(*),
          evidencias(*),
          recursos(*)
        `).order("created_at",{ascending:!1});if(a.data&&a.data.length>0&&(!s.data||s.data.length===0)?(e=a.data,r=a.error):(e=s.data,r=s.error),r)throw r;e&&e.length>0,this.actividadesSubject.next(e||[]);let o=this.actividadesSubject.value}catch{}})}reloadUserFrente(){return i(this,null,function*(){yield this.loadUserFrente()})}loadUserFrente(){return i(this,null,function*(){try{if(!this.directAuthService.getCurrentUser())return;let{data:e,error:r}=yield this.supabase.client.from("frentes").select("*").eq("estado","activo").order("nombre");if(r)throw r;this.frentesSubject.next(e||[])}catch{}})}createActividad(t){return i(this,null,function*(){try{console.log("\u{1F680} ActividadesService.createActividad() iniciado"),console.log("\u{1F4CA} Datos de actividad a crear:",{obraId:t.obra_id,frenteId:t.frente_id,fecha:t.fecha,tipoActividad:t.tipo_actividad}),console.log("\u{1F50D} Verificando autenticaci\xF3n antes de crear actividad...");let e=this.directAuthService.getCurrentUser();if(console.log("\u{1F464} Usuario obtenido:",{hasUser:!!e,userId:e?.id||"null",userEmail:e?.email||"null"}),!e)throw console.error("\u274C Error: Usuario no autenticado en createActividad"),console.log("\u{1F50D} Estado del DirectAuthService:",{isAuthenticated:this.directAuthService.isAuthenticated(),hasToken:!!sessionStorage.getItem("direct_auth_token"),hasStoredUser:!!sessionStorage.getItem("direct_auth_user")}),new Error("Usuario no autenticado");console.log("\u2705 Usuario autenticado, procediendo con la creaci\xF3n...");let r=l(d({},t),{user_id:e.id,created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:a,error:s}=yield this.supabase.client.from("actividades").insert([r]).select(`
          *,
          frente:frentes(*)
        `).single();if(s)throw s;return yield this.loadUserActividades(),a}catch(e){throw e}})}updateActividad(t,e){return i(this,null,function*(){try{let r=l(d({},e),{updated_at:new Date().toISOString()}),{data:a,error:s}=yield this.supabase.client.from("actividades").update(r).eq("id",t).select(`
          *,
          frente:frentes(*)
        `).single();if(s)throw s;return yield this.loadUserActividades(),a}catch(r){throw r}})}deleteActividad(t){return i(this,null,function*(){try{if(!/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(t))throw new Error(`ID no es un UUID v\xE1lido: ${t}`);let{error:r}=yield this.supabase.client.from("actividades").delete().eq("id",t);if(r)throw r;yield this.loadUserActividades()}catch(e){throw e}})}getActividadById(t){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("actividades").select(`
          *,
          frente:frentes(*),
          evidencias(*),
          recursos(*)
        `).eq("id",t).single();if(r)throw r;return e}catch{return null}})}addEvidencia(t){return i(this,null,function*(){try{let e=l(d({},t),{created_at:new Date().toISOString()}),{data:r,error:a}=yield this.supabase.client.from("evidencias").insert([e]).select().single();if(a)throw a;return yield this.loadUserActividades(),r}catch(e){throw e}})}addRecurso(t){return i(this,null,function*(){try{let e=l(d({},t),{created_at:new Date().toISOString()}),{data:r,error:a}=yield this.supabase.client.from("recursos").insert([e]).select().single();if(a)throw a;return yield this.loadUserActividades(),r}catch(e){throw e}})}getActividadesByFrente(t){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("actividades").select(`
          *,
          frente:frentes(*),
          evidencias(*),
          recursos(*)
        `).eq("frente_id",t).order("fecha",{ascending:!1});if(r)throw r;return e||[]}catch{return[]}})}getActividades(){return i(this,null,function*(){try{let t=this.directAuthService.getCurrentUser();if(!t)return[];let{data:e,error:r}=yield this.supabase.client.from("actividades").select(`
          *,
          frente:frentes(*),
          evidencias(*),
          recursos(*)
        `).eq("user_id",t.id).order("created_at",{ascending:!1});if(r)throw r;return e&&e.length>0,e||[]}catch{return[]}})}getActividadesStats(){return i(this,null,function*(){try{let t=yield this.directAuthService.getCurrentUser();if(!t)return null;let{data:e,error:r}=yield this.supabase.client.from("actividades").select("estado").eq("user_id",t.id);if(r)throw r;return{total:e?.length||0,programado:e?.filter(s=>s.estado==="programado").length||0,ejecucion:e?.filter(s=>s.estado==="ejecucion").length||0,finalizado:e?.filter(s=>s.estado==="finalizado").length||0}}catch{return null}})}createTarea(t){return i(this,null,function*(){try{let e=l(d({},t),{created_at:new Date().toISOString(),updated_at:new Date().toISOString()}),{data:r,error:a}=yield this.supabase.client.from("tareas").insert([e]).select().single();if(a)throw a;return r}catch(e){throw e}})}getTareasByActividad(t){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("tareas").select("*").eq("actividad_id",t).order("orden",{ascending:!0});if(r)throw r;return e||[]}catch(e){throw e}})}calcularProgresoActividad(t){return i(this,null,function*(){try{let e=yield this.getTareasByActividad(t);if(e.length===0)return 0;let r=e.filter(s=>s.completada).length;return Math.round(r/e.length*100)}catch{return 0}})}updateActividadEstadoAutomatico(t){return i(this,null,function*(){try{console.log(`[DEBUG] Iniciando actualizaci\xF3n autom\xE1tica de estado para actividad: ${t}`);let{data:e,error:r}=yield this.supabase.client.from("tareas").select("id, completada").eq("actividad_id",t);if(r)throw console.error("[DEBUG] Error obteniendo tareas:",r),r;if(!e||e.length===0){console.log("[DEBUG] No hay tareas para esta actividad");return}let a=e.length,s=e.filter(c=>c.completada).length;console.log(`[DEBUG] Estad\xEDsticas - Total: ${a}, Completadas: ${s}`);let o;s===0?o="programado":s===a?o="finalizado":o="ejecucion",console.log(`[DEBUG] Nuevo estado calculado: ${o}`);let{data:n,error:u}=yield this.supabase.client.from("actividades").select("estado").eq("id",t).single();if(u)throw console.error("[DEBUG] Error obteniendo actividad:",u),u;let f=n?.estado||"programado";if(console.log(`[DEBUG] Estado actual: ${f}`),f!==o){console.log(`[DEBUG] Actualizando estado de ${f} a ${o}`);let{error:c}=yield this.supabase.client.from("actividades").update({estado:o,updated_at:new Date().toISOString()}).eq("id",t);if(c)throw console.error("[DEBUG] Error actualizando estado:",c),c;console.log(`[DEBUG] Estado actualizado exitosamente a: ${o}`),yield this.loadUserActividades()}else console.log("[DEBUG] El estado no necesita cambios")}catch(e){throw console.error("[DEBUG] Error en updateActividadEstadoAutomatico:",e),e}})}updateTareaEstado(t,e){return i(this,null,function*(){try{console.log(`[DEBUG] Actualizando tarea ${t} a completada: ${e}`);let{data:r,error:a}=yield this.supabase.client.from("tareas").select("actividad_id").eq("id",t).single();if(a)throw console.error("[DEBUG] Error obteniendo tarea:",a),a;let s={completada:e,updated_at:new Date().toISOString()};e?s.fecha_completado=new Date().toISOString():s.fecha_completado=null;let{data:o,error:n}=yield this.supabase.client.from("tareas").update(s).eq("id",t).select().single();if(n)throw console.error("[DEBUG] Error actualizando tarea:",n),n;console.log("[DEBUG] Tarea actualizada exitosamente");let u=yield this.calcularProgresoActividad(r.actividad_id);return this.progresoUpdatedSubject.next({actividadId:r.actividad_id,progreso:u}),yield this.updateActividadEstadoAutomatico(r.actividad_id),console.log("[DEBUG] Proceso completo de actualizaci\xF3n de tarea finalizado"),o}catch(r){throw console.error("[DEBUG] Error en updateTareaEstado:",r),r}})}createFrente(t){return i(this,null,function*(){try{if(!this.directAuthService.getCurrentUser())throw new Error("Usuario no autenticado");let r=l(d({},t),{created_at:new Date().toISOString()}),{data:a,error:s}=yield this.supabase.client.from("frentes").insert([r]).select().single();if(s)throw s;return yield this.loadUserFrente(),a}catch(e){throw e}})}updateFrente(t,e){return i(this,null,function*(){try{let{data:r,error:a}=yield this.supabase.client.from("frentes").update(e).eq("id",t).select().single();if(a)throw a;return yield this.loadUserFrente(),r}catch(r){throw r}})}updateFrenteLocation(t,e,r){return i(this,null,function*(){try{let{data:a,error:s}=yield this.supabase.client.from("frentes").update({ubicacion_lat:e,ubicacion_lng:r}).eq("id",t).select().single();if(s)throw s;return yield this.loadUserFrente(),a}catch(a){throw a}})}deleteFrente(t){return i(this,null,function*(){try{let{error:e}=yield this.supabase.client.from("frentes").delete().eq("id",t);if(e)throw e;yield this.loadUserFrente()}catch(e){throw e}})}getFrenteById(t){return i(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("frentes").select("*").eq("id",t).single();if(r)throw r;return e}catch{return null}})}debugUserData(){return i(this,null,function*(){try{let t=this.directAuthService.getCurrentUser(),e=this.directAuthService.getCurrentProfile();if(!t)return;let{data:r,error:a}=yield this.supabase.client.from("user_obras").select("*").eq("user_id",t.id),{data:s,error:o}=yield this.supabase.client.from("actividades").select("id, tipo_actividad, obra_id, user_id, created_at, estado").order("created_at",{ascending:!1}).limit(10);if(r&&r.length>0){let n=r.map(c=>c.obra_id),{data:u,error:f}=yield this.supabase.client.from("actividades").select("id, tipo_actividad, obra_id, user_id, created_at, estado").in("obra_id",n).order("created_at",{ascending:!1})}}catch{}})}getUserObras(){return i(this,null,function*(){try{let t=this.directAuthService.getCurrentUser();if(!t)throw new Error("Usuario no autenticado");let{data:e,error:r}=yield this.supabase.client.from("user_obras").select(`
          obra_id,
          obras(*)
        `).eq("user_id",t.id);if(r)throw r;return e?.map(s=>s.obras)||[]}catch{return[]}})}refresh(){return i(this,null,function*(){yield Promise.all([this.loadUserActividades(),this.loadUserFrente()])})}static{this.\u0275fac=function(e){return new(e||h)(p(U),p(m))}}static{this.\u0275prov=b({token:h,factory:h.\u0275fac,providedIn:"root"})}}return h})();export{D as a};
