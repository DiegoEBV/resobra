import{a as _}from"./chunk-4SALBWPR.js";import{c as P}from"./chunk-ZJYJPMQY.js";import{ba as S,g as K,ga as I}from"./chunk-OYRL5FJJ.js";import{a as f,b as w,i as l}from"./chunk-ODN5LVDJ.js";var j=(()=>{class v{constructor(a,e){this.supabase=a,this.authService=e,this.kpisSubject=new K([]),this.kpis$=this.kpisSubject.asObservable(),this.dashboardKPIsSubject=new K(null),this.dashboardKPIs$=this.dashboardKPIsSubject.asObservable(),this.alertasSubject=new K([]),this.alertas$=this.alertasSubject.asObservable(),this.isInitialized=!1,console.log("\u{1F527} [KpisService] Servicio inicializado - esperando autenticaci\xF3n")}initialize(){return l(this,null,function*(){try{console.log("\u{1F680} [KpisService] Iniciando carga de datos...");let a=yield this.authService.getCurrentUser();if(!a){console.warn("\u26A0\uFE0F [KpisService] No hay usuario autenticado - no se pueden cargar KPIs");return}console.log("\u2705 [KpisService] Usuario autenticado:",a.email),yield Promise.all([this.loadUserKPIs(),this.loadDashboardKPIs(),this.loadAlertas()]),this.isInitialized=!0,console.log("\u2705 [KpisService] Inicializaci\xF3n completada")}catch(a){throw console.error("\u274C [KpisService] Error en inicializaci\xF3n:",a),a}})}isServiceInitialized(){return this.isInitialized}loadUserKPIs(){return l(this,null,function*(){try{console.log("\u{1F4CA} [KpisService] Iniciando carga de KPIs de usuario...");let a=yield this.authService.getCurrentUser();if(!a){console.warn("\u26A0\uFE0F [KpisService] No hay usuario autenticado para cargar KPIs");return}console.log("\u{1F464} [KpisService] Cargando KPIs para usuario:",a.id),console.log("\u{1F3D7}\uFE0F [KpisService] Obteniendo obras del usuario...");let{data:e,error:r}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",a.id);if(r)throw console.error("\u274C [KpisService] Error obteniendo obras del usuario:",r),new Error(`Error obteniendo obras: ${r.message}`);if(!e||e.length===0){console.warn("\u26A0\uFE0F [KpisService] Usuario no tiene obras asignadas"),this.kpisSubject.next([]);return}let o=e.map(n=>n.obra_id);console.log("\u2705 [KpisService] Obras encontradas:",o.length),console.log("\u{1F3D7}\uFE0F [KpisService] Cargando KPIs por obra...");let{data:i,error:c}=yield this.supabase.client.from("kpis").select(`
          *,
          obra:obras(nombre)
        `).in("obra_id",o).is("actividad_id",null);if(c)throw console.error("\u274C [KpisService] Error cargando KPIs de obra:",c),new Error(`Error cargando KPIs de obra: ${c.message}`);console.log("\u2705 [KpisService] KPIs de obra cargados:",i?.length||0),console.log("\u26A1 [KpisService] Cargando actividades de las obras...");let{data:t,error:s}=yield this.supabase.client.from("actividades").select("id").in("obra_id",o),d=[];if(!s&&t&&t.length>0){let n=t.map(b=>b.id);console.log("\u2705 [KpisService] Actividades encontradas:",n.length),console.log("\u{1F4CA} [KpisService] Cargando KPIs de actividades...");let{data:p,error:u}=yield this.supabase.client.from("kpis").select(`
            *,
            actividad:actividades(tipo_actividad, ubicacion)
          `).in("actividad_id",n);if(u)throw console.error("\u274C [KpisService] Error cargando KPIs de actividad:",u),new Error(`Error cargando KPIs de actividad: ${u.message}`);d=p||[],console.log("\u2705 [KpisService] KPIs de actividad cargados:",d.length)}else console.log("\u2139\uFE0F [KpisService] No se encontraron actividades");let h=[...i||[],...d];console.log("\u{1F504} [KpisService] Total KPIs antes de filtrar duplicados:",h.length);let g=h.filter((n,p,u)=>p===u.findIndex(b=>b.id===n.id));console.log("\u2705 [KpisService] KPIs \xFAnicos procesados:",g.length),this.kpisSubject.next(g)}catch(a){throw console.error("\u274C [KpisService] Error cr\xEDtico en loadUserKPIs:",a),this.kpisSubject.next([]),a}})}loadDashboardKPIs(){return l(this,null,function*(){try{console.log("\u{1F4C8} [KpisService] Iniciando carga de KPIs para dashboard...");let a=yield this.authService.getCurrentUser();if(!a){console.warn("\u26A0\uFE0F [KpisService] No hay usuario autenticado para cargar dashboard KPIs");return}console.log("\u{1F464} [KpisService] Cargando dashboard KPIs para usuario:",a.id),console.log("\u{1F3D7}\uFE0F [KpisService] Obteniendo obras del usuario...");let{data:e,error:r}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",a.id);if(r)throw console.error("\u274C [KpisService] Error obteniendo obras del usuario:",r),new Error(`Error obteniendo obras: ${r.message}`);if(!e||e.length===0){console.warn("\u26A0\uFE0F [KpisService] Usuario no tiene obras asignadas"),this.dashboardKPIsSubject.next({rendimiento:{promedio:0,tendencia:"estable",criticos:0},calidad:{promedio:0,tendencia:"estable",criticos:0},seguridad:{promedio:0,tendencia:"estable",criticos:0},costo:{promedio:0,tendencia:"estable",criticos:0},tiempo:{promedio:0,tendencia:"estable",criticos:0}});return}let o=e.map(b=>b.obra_id);console.log("\u2705 [KpisService] Obras encontradas:",o.length);let i=new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0];console.log("\u{1F4CA} [KpisService] Cargando KPIs de obras...");let{data:c,error:t}=yield this.supabase.client.from("kpis").select("avance_fisico, productividad, calidad, desviacion_cronograma").in("obra_id",o).gte("fecha",i);if(t)throw console.error("\u274C [KpisService] Error cargando KPIs de obras:",t),new Error(`Error cargando KPIs de obras: ${t.message}`);console.log("\u2705 [KpisService] KPIs de obras cargados:",c?.length||0),console.log("\u26A1 [KpisService] Cargando actividades de las obras...");let{data:s,error:d}=yield this.supabase.client.from("actividades").select("id").in("obra_id",o);if(d)throw console.error("\u274C [KpisService] Error cargando actividades:",d),new Error(`Error cargando actividades: ${d.message}`);let h=[];if(s&&s.length>0){let b=s.map(y=>y.id);console.log("\u2705 [KpisService] Actividades encontradas:",b.length),console.log("\u{1F4CA} [KpisService] Cargando KPIs de actividades...");let{data:E,error:m}=yield this.supabase.client.from("kpis").select("avance_fisico, productividad, calidad, desviacion_cronograma").in("actividad_id",b).gte("fecha",i);if(m)throw console.error("\u274C [KpisService] Error cargando KPIs de actividades:",m),new Error(`Error cargando KPIs de actividades: ${m.message}`);h=E||[],console.log("\u2705 [KpisService] KPIs de actividades cargados:",h.length)}else console.log("\u2139\uFE0F [KpisService] No se encontraron actividades");let g=c||[],n=h||[],p=[...g,...n];console.log("\u{1F504} [KpisService] Total KPIs para procesar:",p.length);let u=this.processDashboardKPIs(p);console.log("\u2705 [KpisService] Datos procesados para dashboard:",u),this.dashboardKPIsSubject.next(u)}catch(a){throw console.error("\u274C [KpisService] Error cr\xEDtico en loadDashboardKPIs:",a),this.dashboardKPIsSubject.next({rendimiento:{promedio:0,tendencia:"estable",criticos:0},calidad:{promedio:0,tendencia:"estable",criticos:0},seguridad:{promedio:0,tendencia:"estable",criticos:0},costo:{promedio:0,tendencia:"estable",criticos:0},tiempo:{promedio:0,tendencia:"estable",criticos:0}}),a}})}processDashboardKPIs(a){let e={};if(a.length>0){let r=a.reduce((t,s)=>t+(s.avance_fisico||0),0)/a.length,o=a.reduce((t,s)=>t+(s.productividad||0),0)/a.length,i=a.reduce((t,s)=>t+(s.calidad||0),0)/a.length,c="estable";e.rendimiento={promedio:Math.round(r),tendencia:c,criticos:a.filter(t=>(t.avance_fisico||0)<50).length},e.calidad={promedio:Math.round(i),tendencia:c,criticos:a.filter(t=>(t.calidad||0)<70).length},e.seguridad={promedio:85,tendencia:c,criticos:0},e.costo={promedio:80,tendencia:c,criticos:0},e.tiempo={promedio:Math.round(100-Math.abs(a.reduce((t,s)=>t+(s.desviacion_cronograma||0),0)/a.length)),tendencia:c,criticos:a.filter(t=>Math.abs(t.desviacion_cronograma||0)>10).length}}else e.rendimiento={promedio:0,tendencia:"estable",criticos:0},e.calidad={promedio:0,tendencia:"estable",criticos:0},e.seguridad={promedio:0,tendencia:"estable",criticos:0},e.costo={promedio:0,tendencia:"estable",criticos:0},e.tiempo={promedio:0,tendencia:"estable",criticos:0};return e}loadAlertas(){return l(this,null,function*(){try{console.log("\u{1F6A8} [KpisService] Iniciando carga de alertas...");let a=yield this.authService.getCurrentUser();if(!a){console.warn("\u26A0\uFE0F [KpisService] No hay usuario autenticado para cargar alertas");return}console.log("\u{1F464} [KpisService] Cargando alertas para usuario:",a.id),console.log("\u{1F3D7}\uFE0F [KpisService] Obteniendo obras del usuario para alertas...");let{data:e,error:r}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",a.id);if(r)throw console.error("\u274C [KpisService] Error obteniendo obras para alertas:",r),new Error(`Error obteniendo obras para alertas: ${r.message}`);if(!e||e.length===0){console.warn("\u26A0\uFE0F [KpisService] Usuario no tiene obras asignadas - no hay alertas"),this.alertasSubject.next([]);return}let o=e.map(n=>n.obra_id);console.log("\u2705 [KpisService] Obras para alertas encontradas:",o.length),console.log("\u{1F4CA} [KpisService] Cargando KPIs para alertas...");let{data:i,error:c}=yield this.supabase.client.from("kpis").select(`
          id,
          avance_fisico,
          productividad,
          calidad,
          fecha,
          obra:obras(nombre)
        `).in("obra_id",o).order("fecha",{ascending:!1}).limit(5);if(c)throw console.error("\u274C [KpisService] Error cargando KPIs de obras para alertas:",c),new Error(`Error cargando KPIs de obras para alertas: ${c.message}`);console.log("\u2705 [KpisService] KPIs de obras para alertas cargados:",i?.length||0),console.log("\u26A1 [KpisService] Cargando actividades para alertas...");let{data:t,error:s}=yield this.supabase.client.from("actividades").select("id").in("obra_id",o),d=[];if(!s&&t&&t.length>0){let n=t.map(b=>b.id);console.log("\u2705 [KpisService] Actividades para alertas encontradas:",n.length),console.log("\u{1F4CA} [KpisService] Cargando KPIs de actividades para alertas...");let{data:p,error:u}=yield this.supabase.client.from("kpis").select(`
            id,
            avance_fisico,
            productividad,
            calidad,
            fecha,
            actividad:actividades(tipo_actividad, ubicacion)
          `).in("actividad_id",n).order("fecha",{ascending:!1}).limit(5);u?console.error("\u274C [KpisService] Error cargando KPIs de actividades para alertas:",u):(d=p||[],console.log("\u2705 [KpisService] KPIs de actividades para alertas cargados:",d.length))}else console.log("\u2139\uFE0F [KpisService] No se encontraron actividades para alertas");let h=[...i||[],...d];console.log("\u{1F504} [KpisService] Total KPIs para alertas:",h.length);let g=h.map(n=>({id:n.id,avance_fisico:n.avance_fisico,productividad:n.productividad,calidad:n.calidad,fecha:n.fecha,obra_nombre:n.obra?.nombre||"Sin asignar",actividad_tipo:n.actividad?.tipo_actividad||null,actividad_ubicacion:n.actividad?.ubicacion||null}));console.log("\u2705 [KpisService] Alertas procesadas:",g.length),this.alertasSubject.next(g.slice(0,10))}catch(a){throw console.error("\u274C [KpisService] Error cr\xEDtico en loadAlertas:",a),this.alertasSubject.next([]),a}})}createKPI(a){return l(this,null,function*(){try{if(!(yield this.authService.getCurrentUser()))throw new Error("Usuario no autenticado");let r=w(f({},a),{calculated_at:new Date().toISOString()}),{data:o,error:i}=yield this.supabase.client.from("kpis").insert([r]).select(`
          *,
          obra:obras(id, nombre),
          actividad:actividades(id, tipo_actividad, ubicacion, responsable)
        `).single();if(i)throw i;return yield this.refresh(),o}catch(e){throw console.error("Error creating KPI:",e),e}})}updateKPI(a,e){return l(this,null,function*(){try{let r=w(f({},e),{updated_at:new Date().toISOString()}),{data:o,error:i}=yield this.supabase.client.from("kpis").update(r).eq("id",a).select(`
          *,
          obra:obras(id, nombre),
          actividad:actividades(id, tipo_actividad, ubicacion, responsable)
        `).single();if(i)throw i;return e.avance_fisico!==void 0&&(yield this.addKPIHistorial(a,e.avance_fisico,"Avance f\xEDsico actualizado")),yield this.refresh(),o}catch(r){throw console.error("Error updating KPI:",r),r}})}deleteKPI(a){return l(this,null,function*(){try{if(!a||typeof a!="string"||a.trim()==="")throw new Error("ID de KPI inv\xE1lido o vac\xEDo");console.log("\u{1F5D1}\uFE0F Eliminando KPI con ID:",a);let{data:e,error:r}=yield this.supabase.client.from("kpis").select("id, obra_id, actividad_id, created_by").eq("id",a.trim()).single();if(r)throw console.error("Error verificando KPI:",r),r.code==="PGRST116"?new Error("KPI no encontrado - puede haber sido eliminado previamente"):new Error(`No se pudo verificar el KPI: ${r.message}`);if(!e)throw new Error("El KPI no existe o ya fue eliminado");if(console.log("KPI encontrado:",e),!(yield this.authService.getCurrentUser()))throw new Error("Usuario no autenticado");let{error:i}=yield this.supabase.client.from("kpis").delete().eq("id",a.trim());if(i)throw console.error("Error en eliminaci\xF3n:",i),i.code==="42501"?new Error("No tiene permisos para eliminar este KPI"):new Error(`Error al eliminar KPI: ${i.message}`);console.log("\u2705 KPI eliminado exitosamente"),yield this.refresh()}catch(e){throw console.error("Error deleting KPI:",e),e}})}addKPIHistorial(a,e,r){return l(this,null,function*(){try{let o={kpi_id:a,valor:e,fecha_registro:new Date().toISOString(),observaciones:r},{error:i}=yield this.supabase.client.from("kpi_historial").insert([o]);if(i)throw i}catch(o){console.error("Error adding KPI historial:",o)}})}getKPIHistorial(a,e=30){return l(this,null,function*(){try{let{data:r,error:o}=yield this.supabase.client.from("kpi_historial").select("*").eq("kpi_id",a).order("fecha_registro",{ascending:!1}).limit(e);if(o)throw o;return r||[]}catch(r){return console.error("Error getting KPI historial:",r),[]}})}getKPIsByTipo(a){return l(this,null,function*(){try{let e=yield this.authService.getCurrentUser();if(!e)return[];let{data:r,error:o}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",e.id);if(o)throw o;if(r&&r.length>0){let i=r.map(s=>s.obra_id),{data:c,error:t}=yield this.supabase.client.from("kpis").select(`
            *,
            obra:obras(id, nombre),
            actividad:actividades(id, tipo_actividad, ubicacion, responsable)
          `).in("obra_id",i).order("fecha",{ascending:!1});if(t)throw t;return c||[]}return[]}catch(e){return console.error("Error getting KPIs by tipo:",e),[]}})}getEstadisticasGenerales(){return l(this,null,function*(){try{let a=yield this.authService.getCurrentUser();if(!a)return null;let{data:e,error:r}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",a.id);if(r)throw r;if(e&&e.length>0){let o=e.map(s=>s.obra_id),{data:i,error:c}=yield this.supabase.client.from("kpis").select("avance_fisico, productividad, calidad, desviacion_cronograma").in("obra_id",o);if(c)throw c;return{total:i?.length||0,avance_fisico_promedio:i?.length?i.reduce((s,d)=>s+(d.avance_fisico||0),0)/i.length:0,productividad_promedio:i?.length?i.reduce((s,d)=>s+(d.productividad||0),0)/i.length:0,calidad_promedio:i?.length?i.reduce((s,d)=>s+(d.calidad||0),0)/i.length:0,desviacion_cronograma_promedio:i?.length?i.reduce((s,d)=>s+(d.desviacion_cronograma||0),0)/i.length:0}}return null}catch(a){return console.error("Error getting estad\xEDsticas generales:",a),null}})}calculateAutomaticKPIs(a){return l(this,null,function*(){try{console.log("Calculando KPIs autom\xE1ticos para obra:",a);let{data:e,error:r}=yield this.supabase.client.from("actividades").select("*").eq("obra_id",a);if(r)throw r;if(e&&e.length>0){let o=e.filter(p=>p.estado==="finalizado").length,i=e.length,c=i>0?Math.round(o/i*100):0,t=e.reduce((p,u)=>p+(u.progreso_porcentaje||0),0)/i,s=Math.round(t),d=Math.min(100,Math.max(70,s+Math.random()*20-10)),h=new Date().toISOString().split("T")[0],{data:g}=yield this.supabase.client.from("kpis").select("id").eq("obra_id",a).gte("fecha",h).lt("fecha",`${h}T23:59:59`).single(),n={obra_id:a,fecha:new Date().toISOString(),avance_fisico:c,productividad:s,calidad:Math.round(d),desviacion_cronograma:0,calculated_at:new Date().toISOString()};g?(yield this.updateKPI(g.id,n),console.log("KPI autom\xE1tico actualizado para obra:",a)):(yield this.createKPI(n),console.log("KPI autom\xE1tico creado para obra:",a))}else console.log("No hay actividades para calcular KPIs en obra:",a)}catch(e){console.error("Error calculando KPIs autom\xE1ticos:",e)}})}calculateAllAutomaticKPIs(){return l(this,null,function*(){try{let a=yield this.authService.getCurrentUser();if(!a)return;let{data:e,error:r}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",a.id);if(r)throw r;if(e&&e.length>0){console.log("Calculando KPIs autom\xE1ticos para",e.length,"obras");for(let o of e)yield this.calculateAutomaticKPIs(o.obra_id);yield this.refresh(),console.log("KPIs autom\xE1ticos calculados para todas las obras")}}catch(a){console.error("Error calculando KPIs autom\xE1ticos para todas las obras:",a)}})}getActividadesByObra(a){return l(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("actividades").select("id, tipo_actividad, ubicacion, responsable, estado").eq("obra_id",a).order("fecha",{ascending:!1});if(r)throw r;return e||[]}catch(e){return console.error("Error getting actividades by obra:",e),[]}})}getKPIsByActividad(a){return l(this,null,function*(){try{let{data:e,error:r}=yield this.supabase.client.from("kpis").select(`
          *,
          obra:obras(id, nombre),
          actividad:actividades(id, tipo_actividad, ubicacion, responsable)
        `).eq("actividad_id",a).order("fecha",{ascending:!1});if(r)throw r;return e||[]}catch(e){return console.error("Error getting KPIs by actividad:",e),[]}})}calculateAutomaticKPIsForActividad(a){return l(this,null,function*(){try{console.log("Calculando KPIs autom\xE1ticos para actividad:",a);let{data:e,error:r}=yield this.supabase.client.from("actividades").select("*").eq("id",a).single();if(r)throw r;if(e){let o=e.progreso_porcentaje||0,i=this.calculateProductividadFromActividad(e),c=this.calculateCalidadFromActividad(e),t=new Date().toISOString().split("T")[0],{data:s}=yield this.supabase.client.from("kpis").select("id").eq("actividad_id",a).gte("fecha",t).lt("fecha",`${t}T23:59:59`).single(),d={actividad_id:a,fecha:new Date().toISOString(),avance_fisico:o,productividad:i,calidad:c,desviacion_cronograma:this.calculateDesviacionFromActividad(e),calculated_at:new Date().toISOString()};s?(yield this.updateKPI(s.id,d),console.log("KPI autom\xE1tico actualizado para actividad:",a)):(yield this.createKPI(d),console.log("KPI autom\xE1tico creado para actividad:",a))}}catch(e){console.error("Error calculando KPIs autom\xE1ticos para actividad:",e)}})}calculateProductividadFromActividad(a){let e=a.progreso_porcentaje||0,r=a.estado==="finalizado"?1.1:.9;return Math.min(100,Math.round(e*r))}calculateCalidadFromActividad(a){let r=a.estado==="finalizado"?1.2:1;return Math.min(100,Math.round(80*r))}calculateDesviacionFromActividad(a){return 0}refresh(){return l(this,null,function*(){yield Promise.all([this.loadUserKPIs(),this.loadDashboardKPIs(),this.loadAlertas()])})}static{this.\u0275fac=function(e){return new(e||v)(I(P),I(_))}}static{this.\u0275prov=S({token:v,factory:v.\u0275fac,providedIn:"root"})}}return v})();export{j as a};
