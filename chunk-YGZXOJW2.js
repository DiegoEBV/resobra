import{a as f}from"./chunk-4SALBWPR.js";import{c as h}from"./chunk-ZJYJPMQY.js";import{E as u,ba as d,g as c,ga as n,j as l,q as b}from"./chunk-OYRL5FJJ.js";import{i as t}from"./chunk-ODN5LVDJ.js";var y=(()=>{class s{constructor(r,e){this.supabase=r,this.authService=e,this.obrasSubject=new c([]),this.obras$=this.obrasSubject.asObservable(),this.loadObras()}loadObras(){return t(this,null,function*(){try{let r=yield this.authService.getCurrentUser();if(!r){this.obrasSubject.next([]);return}let{data:e,error:o}=yield this.supabase.client.from("user_obras").select("obra_id").eq("user_id",r.id);if(o)throw console.error("Error loading user obras:",o),o;if(!e||e.length===0){this.obrasSubject.next([]);return}let a=e.map(g=>g.obra_id),{data:p,error:i}=yield this.supabase.client.from("obras").select("*").in("id",a).order("nombre");if(i)throw console.error("Error loading obras:",i),i;this.obrasSubject.next(p||[])}catch(r){console.error("Error in loadObras:",r),this.obrasSubject.next([])}})}getObraById(r){return l(this.supabase.client.from("obras").select("*").eq("id",r).single()).pipe(b(({data:e,error:o})=>o?(console.error("Error getting obra:",o),null):e),u(e=>(console.error("Error in getObraById:",e),[null])))}getAllObras(){return t(this,null,function*(){try{console.log("\u{1F4CB} ObrasService: Cargando todas las obras desde Supabase");let r=yield this.authService.getCurrentUser();console.log("\u{1F464} ObrasService: Usuario actual:",r?r.email:"No autenticado");let{data:e,error:o}=yield this.supabase.client.from("obras").select("*").order("nombre");if(o)throw console.error("\u274C Error getting all obras:",o),console.error("\u274C Error code:",o.code),console.error("\u274C Error message:",o.message),console.error("\u274C Error details:",o.details),o;let a=e||[];return console.log("\u2705 ObrasService: Obras cargadas desde Supabase:",a.length),console.log("\u{1F4CA} ObrasService: Datos de obras:",a),a}catch(r){throw console.error("\u274C Error in getAllObras:",r),console.error("\u274C Error type:",typeof r),console.error("\u274C Error stack:",r instanceof Error?r.stack:"No stack"),r}})}createObra(r){return t(this,null,function*(){try{let{data:e,error:o}=yield this.supabase.client.from("obras").insert([r]).select().single();if(o)throw console.error("Error creating obra:",o),o;return yield this.loadObras(),e}catch(e){return console.error("Error in createObra:",e),null}})}updateObra(r,e){return t(this,null,function*(){try{let{data:o,error:a}=yield this.supabase.client.from("obras").update(e).eq("id",r).select().single();if(a)throw console.error("Error updating obra:",a),a;return yield this.loadObras(),o}catch(o){return console.error("Error in updateObra:",o),null}})}deleteObra(r){return t(this,null,function*(){try{console.log("\u{1F5D1}\uFE0F ObrasService: Eliminando obra desde Supabase:",r);let{error:e}=yield this.supabase.client.from("obras").delete().eq("id",r);if(e)throw console.error("\u274C Error deleting obra:",e),e;return console.log("\u2705 ObrasService: Obra eliminada exitosamente"),yield this.loadObras(),!0}catch(e){return console.error("\u274C Error in deleteObra:",e),!1}})}static{this.\u0275fac=function(e){return new(e||s)(n(h),n(f))}}static{this.\u0275prov=d({token:s,factory:s.\u0275fac,providedIn:"root"})}}return s})();export{y as a};
