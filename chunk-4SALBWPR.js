import{c as S}from"./chunk-ZJYJPMQY.js";import{Z as f,ba as p,g as d,ga as k,j as g,q as h,z as b}from"./chunk-OYRL5FJJ.js";import{a as l,b as u,i}from"./chunk-ODN5LVDJ.js";var w=(()=>{class a{constructor(){this.lockStatusSubject=new d(!1),this.lockStatus$=this.lockStatusSubject.asObservable(),this.startMonitoring()}startMonitoring(){this.monitoringSubscription=b(3e4).subscribe(()=>{this.checkAndCleanLocks()}),setTimeout(()=>this.checkAndCleanLocks(),1e3)}checkAndCleanLocks(){return i(this,null,function*(){try{if("locks"in navigator&&navigator.locks){let e=yield navigator.locks.query();e.pending&&e.pending.length>0&&e.pending?(console.log("\u{1F50D} LockMonitor: Detectados locks pendientes:",e.pending),e.pending.filter(s=>s.name&&(s.name.includes("sb-auth-token")||s.name.includes("supabase"))).length>0&&(console.log("\u{1F9F9} LockMonitor: Limpiando locks atascados..."),yield this.forceCleanLocks(),this.lockStatusSubject.next(!0))):this.lockStatusSubject.next(!1)}}catch(e){console.warn("\u26A0\uFE0F LockMonitor: Error verificando locks:",e)}})}forceCleanLocks(){return i(this,null,function*(){try{console.log("\u{1F513} LockMonitor: Iniciando limpieza forzada de locks..."),["lock:sb-auth-token","lock:sb-auth-token-resobra","sb-auth-token","supabase.auth.token","sb-"+window.location.hostname+"-auth-token","sb-auth-token-"+window.location.hostname,"supabase-auth-token"].forEach(o=>{try{localStorage.removeItem(o),sessionStorage.removeItem(o)}catch(r){console.warn(`\u26A0\uFE0F Error removing ${o}:`,r)}}),this.cleanStorageByPattern(["lock","sb-"]),console.log("\u2705 LockMonitor: Limpieza forzada completada")}catch(e){console.error("\u274C LockMonitor: Error en limpieza forzada:",e)}})}cleanStorageByPattern(e){try{for(let o=localStorage.length-1;o>=0;o--){let r=localStorage.key(o);r&&e.some(s=>r.includes(s))&&(console.log(`\u{1F5D1}\uFE0F Removing localStorage key: ${r}`),localStorage.removeItem(r))}for(let o=sessionStorage.length-1;o>=0;o--){let r=sessionStorage.key(o);r&&e.some(s=>r.includes(s))&&(console.log(`\u{1F5D1}\uFE0F Removing sessionStorage key: ${r}`),sessionStorage.removeItem(r))}}catch(o){console.warn("\u26A0\uFE0F Error cleaning storage by pattern:",o)}}getLockInfo(){return i(this,null,function*(){try{return"locks"in navigator&&navigator.locks?yield navigator.locks.query():null}catch(e){return console.warn("\u26A0\uFE0F Error getting lock info:",e),null}})}stopMonitoring(){this.monitoringSubscription&&(this.monitoringSubscription.unsubscribe(),this.monitoringSubscription=void 0)}ngOnDestroy(){this.stopMonitoring()}static{this.\u0275fac=function(o){return new(o||a)}}static{this.\u0275prov=p({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();var M=(()=>{class a{constructor(e){this.supabase=e,this.currentUserSubject=new d(null),this.currentProfileSubject=new d(null),this.sessionSubject=new d(null),this.lockMonitor=new w,this.currentUser$=this.currentUserSubject.asObservable(),this.currentProfile$=this.currentProfileSubject.asObservable(),this.session$=this.sessionSubject.asObservable(),this.isAuthenticated$=this.currentUser$.pipe(h(o=>!!o)),this.lockMonitor.lockStatus$.subscribe(o=>{o&&console.log("\u{1F504} AuthService: Locks limpiados, reintentando operaciones...")}),this.loadInitialSession()}clearAuthLocks(){return i(this,null,function*(){try{console.log("\u{1F9F9} Limpiando locks de autenticaci\xF3n..."),yield this.lockMonitor.forceCleanLocks(),console.log("\u2705 Locks de autenticaci\xF3n limpiados")}catch(e){console.warn("\u26A0\uFE0F Error limpiando locks:",e)}})}loadInitialSession(){return i(this,null,function*(){let o=0;for(;o<3;)try{console.log(`\u{1F504} Intento ${o+1}/3 de carga de sesi\xF3n inicial...`);let r=this.supabase.auth.getSession(),s=new Promise((c,m)=>setTimeout(()=>m(new Error("Session timeout - No se pudo cargar la sesi\xF3n")),3e4)),{data:{session:t},error:n}=yield Promise.race([r,s]);if(n){if(console.warn(`\u26A0\uFE0F Error loading initial session (attempt ${o+1}):`,n),n.message&&(n.message.includes("NavigatorLockAcquireTimeoutError")||n.message.includes("lock")||n.message.includes("timeout"))){console.log("\u{1F513} Detected lock-related error, clearing locks and retrying..."),yield this.clearAuthLocks();let c=Math.min(1e3*Math.pow(2,o),5e3);console.log(`\u23F3 Esperando ${c}ms antes del siguiente intento...`),yield this.delay(c),o++;continue}console.error("\u274C Error no relacionado con locks:",n);return}console.log("\u2705 Sesi\xF3n cargada exitosamente"),console.log("\u{1F4CB} Contenido de la sesi\xF3n:",{hasSession:!!t,hasUser:!!t?.user,userEmail:t?.user?.email,sessionId:t?.access_token?"presente":"ausente"}),t?.user&&(console.log("\u{1F464} Usuario de sesi\xF3n:",t.user.email),console.log("\u{1F511} Token de acceso:",t.access_token?"presente":"ausente")),this.sessionSubject.next(t),this.currentUserSubject.next(t?.user||null),t?.user?(yield this.loadUserProfile(t.user.id),console.log("\u{1F510} Estado de autenticaci\xF3n actualizado a: true")):(console.log("\u{1F510} Estado de autenticaci\xF3n actualizado a: false"),console.log("\u274C No hay usuario en la sesi\xF3n - usuario debe hacer login"));return}catch(r){if(console.warn(`\u26A0\uFE0F Error en intento ${o+1}:`,r),r.message&&(r.message.includes("timeout")||r.message.includes("NavigatorLockAcquireTimeoutError")||r.message.includes("lock"))){yield this.clearAuthLocks();let s=Math.min(1e3*Math.pow(2,o),5e3);console.log(`\u23F3 Esperando ${s}ms antes del siguiente intento...`),yield this.delay(s),o++;continue}console.error("\u274C Error no recuperable:",r);return}console.error("\u274C Se agotaron todos los intentos de carga de sesi\xF3n")})}loadSession(){return i(this,null,function*(){try{console.log("\u{1F504} Cargando sesi\xF3n...");let{data:{session:e},error:o}=yield this.supabase.auth.getSession();if(o){console.error("\u274C Error al cargar sesi\xF3n:",o),this.sessionSubject.next(null);return}console.log("\u2705 Sesi\xF3n cargada exitosamente"),console.log("\u{1F4CB} Contenido de la sesi\xF3n:",{hasSession:!!e,hasUser:!!e?.user,userEmail:e?.user?.email,sessionId:e?.access_token?"presente":"ausente"}),this.sessionSubject.next(e),this.currentUserSubject.next(e?.user||null),e?.user?(yield this.loadUserProfile(e.user.id),console.log("\u{1F510} Estado de autenticaci\xF3n actualizado a: true")):(console.log("\u{1F510} Estado de autenticaci\xF3n actualizado a: false"),console.log("\u274C No hay usuario en la sesi\xF3n - usuario debe hacer login"))}catch(e){console.error("\u274C Error inesperado al cargar sesi\xF3n:",e),this.sessionSubject.next(null)}})}loadUserProfile(e){return i(this,null,function*(){try{console.log("\u{1F464} Cargando perfil del usuario:",e);let{data:o,error:r}=yield this.supabase.db.from("users").select("*").eq("id",e).single();if(r){console.warn("Could not load user profile:",r.message),r.code==="PGRST116"&&(console.log("User profile not found, creating basic profile..."),yield this.createBasicProfile(e));return}o&&(console.log("\u2705 Perfil cargado:",o.nombre,"-",o.rol),this.currentProfileSubject.next(o),console.log("\u{1F4CA} Perfil actualizado en BehaviorSubject"))}catch(o){console.warn("Error loading user profile:",o)}})}signIn(e,o){return g(this.signInWithRetry(e,o)).pipe(h(({data:r,error:s})=>{if(r?.user&&!s)return console.log("\u2705 Login exitoso para:",e),this.loadUserProfile(r.user.id),{user:r.user,error:null};if(s){console.log("\u274C Error de autenticaci\xF3n:",s),console.log("\u{1F4DD} Mensaje de error:",s.message);let t=s;return s.message&&(s.message.includes("Invalid login credentials")?t=u(l({},s),{message:"Credenciales de acceso inv\xE1lidas. Verifique su email y contrase\xF1a.",__isAuthError:!0}):s.message.includes("Email not confirmed")?t=u(l({},s),{message:"La cuenta no ha sido confirmada. Por favor contacte al administrador.",__isAuthError:!0}):s.message.includes("Too many requests")?t=u(l({},s),{message:"Demasiados intentos de acceso. Intente nuevamente en unos minutos.",__isAuthError:!0}):s.message.includes("NavigatorLockAcquireTimeoutError")||s.message.includes("lock")?t=u(l({},s),{message:"Error temporal del sistema. Intente nuevamente en unos segundos.",__isAuthError:!0}):t=u(l({},s),{message:s.message||"Error de autenticaci\xF3n",__isAuthError:!0})),{user:null,error:t}}return{user:r?.user||null,error:s}}))}signInWithRetry(e,o,r=3){return i(this,null,function*(){let s=0;for(;s<r;)try{console.log(`\u{1F504} Intento de login ${s+1}/${r} para: ${e}`);let t=this.supabase.auth.signInWithPassword({email:e,password:o}),n=new Promise((m,E)=>setTimeout(()=>E(new Error("Login timeout - La conexi\xF3n tard\xF3 demasiado")),45e3)),c=yield Promise.race([t,n]);if(c.error&&c.error.message&&(c.error.message.includes("NavigatorLockAcquireTimeoutError")||c.error.message.includes("lock")||c.error.message.includes("timeout"))){console.log(`\u{1F513} Error de lock detectado en intento ${s+1}, limpiando locks...`),yield this.clearAuthLocks();let m=Math.min(2e3*Math.pow(2,s),8e3);console.log(`\u23F3 Esperando ${m}ms antes del siguiente intento...`),yield this.delay(m),s++;continue}return console.log(`\u2705 Login completado en intento ${s+1}`),c}catch(t){if(console.warn(`\u26A0\uFE0F Error en intento de login ${s+1}:`,t),t.message&&(t.message.includes("timeout")||t.message.includes("NavigatorLockAcquireTimeoutError")||t.message.includes("lock"))){yield this.clearAuthLocks();let n=Math.min(2e3*Math.pow(2,s),8e3);console.log(`\u23F3 Esperando ${n}ms antes del siguiente intento...`),yield this.delay(n),s++;continue}return console.error("\u274C Error no recuperable en login:",t),{data:null,error:t}}return console.error("\u274C Se agotaron todos los intentos de login"),{data:null,error:{message:"No se pudo conectar con el servidor. Verifique su conexi\xF3n a internet e intente nuevamente.",__isAuthError:!0,code:"MAX_RETRIES_EXCEEDED"}}})}findUserByEmail(e){return i(this,null,function*(){try{let{data:o,error:r}=yield this.supabase.db.from("users").select("*").eq("email",e).single();return r?(console.error("Error buscando usuario por email:",r),null):o}catch(o){return console.error("Error buscando usuario por email:",o),null}})}signUp(e,o,r,s="logistica"){return g(this.supabase.auth.signUp({email:e,password:o})).pipe(f(c=>i(this,[c],function*({data:t,error:n}){t.user&&!n&&(yield this.createUserProfile(t.user.id,e,r,s))})),h(({data:t,error:n})=>({user:t.user,error:n})))}createUserProfile(e,o,r,s){return i(this,null,function*(){try{let{error:t}=yield this.supabase.db.from("users").insert({id:e,email:o,nombre:r,rol:s});t?console.error("Error creating user profile:",t):yield this.loadUserProfile(e)}catch(t){console.error("Error creating user profile:",t)}})}createBasicProfile(e){return i(this,null,function*(){try{let o=this.getCurrentUser();if(!o)return;let{error:r}=yield this.supabase.db.from("users").insert({id:e,email:o.email||"usuario@ejemplo.com",nombre:o.email?.split("@")[0]||"Usuario",rol:"logistica"});r?console.error("Error creating basic profile:",r):yield this.loadUserProfile(e)}catch(o){console.error("Error creating basic profile:",o)}})}forceAuthStateUpdate(){return i(this,null,function*(){try{console.log("\u{1F504} Forzando actualizaci\xF3n del estado de autenticaci\xF3n...");let{data:{session:e},error:o}=yield this.supabase.auth.getSession();if(o){console.error("\u274C Error obteniendo sesi\xF3n:",o);return}e?.user?(console.log("\u2705 Sesi\xF3n v\xE1lida encontrada, actualizando estado..."),this.currentUserSubject.next(e.user),this.sessionSubject.next(e),yield this.loadUserProfile(e.user.id),console.log("\u2705 Estado de autenticaci\xF3n actualizado correctamente")):(console.log("\u26A0\uFE0F No hay sesi\xF3n v\xE1lida"),this.currentUserSubject.next(null),this.currentProfileSubject.next(null),this.sessionSubject.next(null))}catch(e){console.error("\u274C Error forzando actualizaci\xF3n del estado:",e)}})}signOut(){return g(this.supabase.auth.signOut()).pipe(f(()=>{this.currentUserSubject.next(null),this.currentProfileSubject.next(null),this.sessionSubject.next(null)}),h(({error:e})=>({error:e})))}getCurrentUser(){return this.currentUserSubject.value}getCurrentProfile(){return this.currentProfileSubject.value}isResident(){return this.getCurrentProfile()?.rol==="residente"}isLogistics(){return this.getCurrentProfile()?.rol==="logistica"}updateProfile(e){let o=this.getCurrentUser()?.id;if(!o)throw new Error("No user logged in");return g(this.supabase.db.from("users").update(u(l({},e),{updated_at:new Date().toISOString()})).eq("id",o).select().single()).pipe(f(({data:r,error:s})=>{r&&!s&&this.currentProfileSubject.next(r)}))}resetPassword(e){return g(this.supabase.auth.resetPasswordForEmail(e)).pipe(h(({error:o})=>({error:o})))}delay(e){return new Promise(o=>setTimeout(o,e))}static{this.\u0275fac=function(o){return new(o||a)(k(S))}}static{this.\u0275prov=p({token:a,factory:a.\u0275fac,providedIn:"root"})}}return a})();export{M as a};
