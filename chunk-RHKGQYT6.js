import{a as _}from"./chunk-XMK3WWTR.js";import{a as h}from"./chunk-ODA4OOHJ.js";import{a as I}from"./chunk-NYQK5656.js";import{c as E}from"./chunk-ZJYJPMQY.js";import{E as S,ba as f,ga as l,k as c,q as p}from"./chunk-OYRL5FJJ.js";import{a as g,b as d,i as m}from"./chunk-ODN5LVDJ.js";var y=(()=>{class n{constructor(t,e,r,o){this.supabase=t,this.reportsService=e,this.itemsService=r,this.projectsService=o,this.STORAGE_KEYS={AUTOCOMPLETE:"bitepoint_autocomplete_data",FAVORITES:"bitepoint_favorite_items",QUICK_TEMPLATES:"bitepoint_quick_templates",LAST_BACKUP:"bitepoint_last_backup"},this.initializeAutoBackup()}getAutoCompleteData(){let t=localStorage.getItem(this.STORAGE_KEYS.AUTOCOMPLETE);return t?JSON.parse(t):{descriptions:[],quantities:[],observations:[]}}updateAutoCompleteData(t){return new Promise(e=>{this.updateAutoCompleteField("descriptions",t.description),this.updateAutoCompleteField("quantities",t.quantity.toString()),e()})}updateAutoCompleteField(t,e){let r=this.getAutoCompleteData();if(t==="quantities"&&typeof e=="number")r.quantities.includes(e)||(r.quantities.push(e),r.quantities.sort((o,i)=>i-o),r.quantities=r.quantities.slice(0,10));else if(typeof e=="string"&&e.trim()){let o=t;r[o].includes(e)||(r[o].unshift(e),r[o]=r[o].slice(0,20))}localStorage.setItem(this.STORAGE_KEYS.AUTOCOMPLETE,JSON.stringify(r))}getAutoCompleteSuggestions(t,e){let o=this.getAutoCompleteData()[t];return e.trim()?o.filter(i=>i.toLowerCase().includes(e.toLowerCase())).slice(0,5):o.slice(0,5)}getFavoriteItems(){let t=localStorage.getItem(this.STORAGE_KEYS.FAVORITES);if(!t)return c([]);let e=JSON.parse(t);return e.map(o=>o.item_id).length===0?c([]):this.itemsService.getAllItems().pipe(p(o=>e.map(a=>{let s=o.find(u=>u.id===a.item_id);return s?d(g({},a),{item:s}):null}).filter(a=>a!==null).sort((a,s)=>s.usage_count-a.usage_count)),S(()=>c([])))}markItemAsUsed(t){let e=localStorage.getItem(this.STORAGE_KEYS.FAVORITES),r=e?JSON.parse(e):[],o=r.findIndex(i=>i.item_id===t);if(o>=0)r[o].usage_count++,r[o].last_used=new Date().toISOString();else{this.itemsService.getItemById(t).subscribe(i=>{i&&(r.push({item_id:t,item:i,usage_count:1,last_used:new Date().toISOString()}),localStorage.setItem(this.STORAGE_KEYS.FAVORITES,JSON.stringify(r)))});return}localStorage.setItem(this.STORAGE_KEYS.FAVORITES,JSON.stringify(r))}getLastReport(t){return this.reportsService.getReportsByProject(t).pipe(p(e=>e.length>0?e[0]:null),S(()=>c(null)))}copyPreviousReport(t){return m(this,null,function*(){try{let e=yield this.reportsService.getReportById(t).toPromise();if(!e)throw new Error("Reporte no encontrado");let r=e.report_items||[],o=yield this.projectsService.getProjectById(e.project_id).toPromise();return{items:r,project:o}}catch(e){throw console.error("Error copiando reporte anterior:",e),e}})}getQuickReportTemplate(t){let e=localStorage.getItem(this.STORAGE_KEYS.QUICK_TEMPLATES);return e&&JSON.parse(e)[t]||null}getQuickReportTemplates(){let t=localStorage.getItem(this.STORAGE_KEYS.QUICK_TEMPLATES);if(!t)return[];let e=JSON.parse(t);return Object.values(e)}saveQuickReportTemplate(t){let e=localStorage.getItem(this.STORAGE_KEYS.QUICK_TEMPLATES),r=e?JSON.parse(e):{},o=t.items.map(a=>a.item?.id).filter(a=>a),i={};t.items.forEach(a=>{a.item?.id&&a.currentQuantity&&(i[a.item.id]=a.currentQuantity)}),r[t.projectId]={project_id:t.projectId,favorite_items:o,default_quantities:i},localStorage.setItem(this.STORAGE_KEYS.QUICK_TEMPLATES,JSON.stringify(r))}createQuickReportFromTemplate(t,e){return m(this,null,function*(){try{let r=this.getQuickReportTemplate(e);if(!r)throw new Error("Plantilla no encontrada");let o=(yield this.itemsService.getAllItems().toPromise())||[];return{items:r.favorite_items.map(s=>o.find(u=>u.id===s)).filter(s=>s!==void 0).map(s=>({item:s,currentQuantity:r.default_quantities[s.id]||1,previousQuantity:0}))}}catch(r){throw console.error("Error creando reporte desde plantilla:",r),r}})}createQuickReport(t){let e=this.getQuickReportTemplate(t);return e?this.itemsService.getAllItems().pipe(p(r=>{let o=e.favorite_items.map(i=>r.find(a=>a.id===i)).filter(i=>i!==void 0);return this.generateQuickReportData(t,o)})):this.getFavoriteItems().pipe(p(r=>{let o=r.slice(0,5);return this.generateQuickReportData(t,o.map(i=>i.item))}))}generateQuickReportData(t,e){let r=new Date,o=`INF-${r.getFullYear()}-${(Math.floor(Math.random()*900)+100).toString()}`;return{report:{project_id:t,report_number:o,report_date:r.toISOString().split("T")[0],period_start:void 0,period_end:void 0,status:"draft"},items:e}}performBackup(){return new Promise((t,e)=>{try{this.performAutoBackup(),t()}catch(r){e(r)}})}initializeAutoBackup(){return new Promise(t=>{this.initializeAutoBackupInternal(),t()})}initializeAutoBackupInternal(){console.log("Backup autom\xE1tico deshabilitado para resolver problemas de concurrencia con NavigatorLockManager"),console.log("Use performBackup() manualmente cuando sea necesario");let t=localStorage.getItem(this.STORAGE_KEYS.LAST_BACKUP),e=new Date().getTime(),r=24*60*60*1e3;(!t||e-parseInt(t)>r)&&this.performAutoBackup()}performAutoBackup(){try{let t={timestamp:new Date().toISOString(),autocomplete:this.getAutoCompleteData(),favorites:localStorage.getItem(this.STORAGE_KEYS.FAVORITES),templates:localStorage.getItem(this.STORAGE_KEYS.QUICK_TEMPLATES)},e=`bitepoint_backup_${new Date().toISOString().split("T")[0]}`;localStorage.setItem(e,JSON.stringify(t)),this.cleanOldBackups(),localStorage.setItem(this.STORAGE_KEYS.LAST_BACKUP,new Date().getTime().toString()),console.log("Backup autom\xE1tico completado:",new Date().toISOString())}catch(t){console.error("Error en backup autom\xE1tico:",t)}}cleanOldBackups(){let t=new Date;t.setDate(t.getDate()-7);let e=t.toISOString().split("T")[0];Object.keys(localStorage).filter(r=>r.startsWith("bitepoint_backup_")).forEach(r=>{r.replace("bitepoint_backup_","")<e&&localStorage.removeItem(r)})}restoreFromBackup(t){try{let e=`bitepoint_backup_${t}`,r=localStorage.getItem(e);if(!r)return!1;let o=JSON.parse(r);return o.autocomplete&&localStorage.setItem(this.STORAGE_KEYS.AUTOCOMPLETE,JSON.stringify(o.autocomplete)),o.favorites&&localStorage.setItem(this.STORAGE_KEYS.FAVORITES,o.favorites),o.templates&&localStorage.setItem(this.STORAGE_KEYS.QUICK_TEMPLATES,o.templates),console.log("Backup restaurado exitosamente:",t),!0}catch(e){return console.error("Error restaurando backup:",e),!1}}getAvailableBackups(){return Object.keys(localStorage).filter(t=>t.startsWith("bitepoint_backup_")).map(t=>t.replace("bitepoint_backup_","")).sort().reverse()}static{this.\u0275fac=function(e){return new(e||n)(l(E),l(_),l(I),l(h))}}static{this.\u0275prov=f({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{y as a};
