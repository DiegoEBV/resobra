import{a as k}from"./chunk-WFXXN3GR.js";import{Z as f,ba as g,g as h,ga as S,j as m,q as d,z as p}from"./chunk-B6672ACT.js";import{a as c,b as l,i as a}from"./chunk-ODN5LVDJ.js";var w=(()=>{class n{constructor(){this.lockStatusSubject=new h(!1),this.lockStatus$=this.lockStatusSubject.asObservable()}startMonitoring(){}checkAndCleanLocks(){return a(this,null,function*(){try{if("locks"in navigator&&navigator.locks){let t=yield navigator.locks.query();t.pending&&t.pending.length>0&&t.pending?t.pending.filter(r=>r.name&&(r.name.includes("sb-auth-token")||r.name.includes("supabase"))).length>0&&(yield this.forceCleanLocks(),this.lockStatusSubject.next(!0)):this.lockStatusSubject.next(!1)}}catch{}})}forceCleanLocks(){return a(this,null,function*(){try{["lock:sb-auth-token","lock:sb-auth-token-resobra","sb-auth-token","supabase.auth.token","sb-"+window.location.hostname+"-auth-token","sb-auth-token-"+window.location.hostname,"supabase-auth-token"].forEach(e=>{try{localStorage.removeItem(e),sessionStorage.removeItem(e)}catch{}}),this.cleanStorageByPattern(["lock","sb-"])}catch{}})}cleanStorageByPattern(t){try{for(let e=localStorage.length-1;e>=0;e--){let s=localStorage.key(e);s&&t.some(r=>s.includes(r))&&localStorage.removeItem(s)}for(let e=sessionStorage.length-1;e>=0;e--){let s=sessionStorage.key(e);s&&t.some(r=>s.includes(r))&&sessionStorage.removeItem(s)}}catch{}}getLockInfo(){return a(this,null,function*(){try{return"locks"in navigator&&navigator.locks?yield navigator.locks.query():null}catch{return null}})}stopMonitoring(){this.monitoringSubscription&&(this.monitoringSubscription.unsubscribe(),this.monitoringSubscription=void 0)}ngOnDestroy(){this.stopMonitoring()}static{this.\u0275fac=function(e){return new(e||n)}}static{this.\u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();var L=(()=>{class n{constructor(t){this.supabase=t,this.currentUserSubject=new h(null),this.currentProfileSubject=new h(null),this.sessionSubject=new h(null),this.lockMonitor=new w,this.currentUser$=this.currentUserSubject.asObservable(),this.currentProfile$=this.currentProfileSubject.asObservable(),this.session$=this.sessionSubject.asObservable(),this.isAuthenticated$=this.currentUser$.pipe(d(e=>!!e)),this.lockMonitor.lockStatus$.subscribe(e=>{}),this.setupAuthStateListener(),this.loadInitialSession()}setupAuthStateListener(){this.supabase.auth.onAuthStateChange((t,e)=>{switch(t){case"SIGNED_IN":this.sessionSubject.next(e),this.currentUserSubject.next(e?.user||null),e?.user&&this.loadUserProfile(e.user.id);break;case"SIGNED_OUT":this.sessionSubject.next(null),this.currentUserSubject.next(null),this.currentProfileSubject.next(null);break;case"TOKEN_REFRESHED":this.sessionSubject.next(e);break;case"USER_UPDATED":e?.user&&(this.currentUserSubject.next(e.user),this.loadUserProfile(e.user.id));break}})}clearAuthLocks(){return a(this,null,function*(){try{["lock:sb-auth-token","lock:sb-auth-token-resobra","sb-auth-token","supabase.auth.token","sb-"+window.location.hostname+"-auth-token"].forEach(e=>{try{localStorage.removeItem(e),sessionStorage.removeItem(e)}catch{}})}catch{}})}loadInitialSession(){return a(this,null,function*(){let e=0;for(;e<3;)try{let s=this.supabase.auth.getSession(),r=new Promise((u,b)=>setTimeout(()=>b(new Error("Session timeout - No se pudo cargar la sesi\xF3n")),3e4)),{data:{session:i},error:o}=yield Promise.race([s,r]);if(o){if(o.message&&(o.message.includes("NavigatorLockAcquireTimeoutError")||o.message.includes("lock")||o.message.includes("timeout"))){yield this.clearAuthLocks();let u=Math.min(1e3*Math.pow(2,e),5e3);yield this.delay(u),e++;continue}return}i?.user,this.sessionSubject.next(i),this.currentUserSubject.next(i?.user||null),i?.user&&(yield this.loadUserProfile(i.user.id));return}catch(s){if(s.message&&(s.message.includes("timeout")||s.message.includes("NavigatorLockAcquireTimeoutError")||s.message.includes("lock"))){yield this.clearAuthLocks();let r=Math.min(1e3*Math.pow(2,e),5e3);yield this.delay(r),e++;continue}return}})}loadSession(){return a(this,null,function*(){try{let{data:{session:t},error:e}=yield this.supabase.auth.getSession();if(e){this.sessionSubject.next(null);return}this.sessionSubject.next(t),this.currentUserSubject.next(t?.user||null),t?.user&&(yield this.loadUserProfile(t.user.id))}catch{this.sessionSubject.next(null)}})}loadUserProfile(t){return a(this,null,function*(){try{let{data:e,error:s}=yield this.supabase.db.from("users").select("*").eq("id",t).single();if(s){s.code==="PGRST116"&&(yield this.createBasicProfile(t));return}e&&this.currentProfileSubject.next(e)}catch{}})}signIn(t,e){return m(this.signInWithRetry(t,e)).pipe(d(({data:s,error:r})=>{if(s?.user&&!r)return this.loadUserProfile(s.user.id),{user:s.user,error:null};if(r){let i=r;return r.message&&(r.message.includes("Invalid login credentials")?i=l(c({},r),{message:"Credenciales de acceso inv\xE1lidas. Verifique su email y contrase\xF1a.",__isAuthError:!0}):r.message.includes("Too many requests")?i=l(c({},r),{message:"Demasiados intentos de acceso. Intente nuevamente en unos minutos.",__isAuthError:!0}):r.message.includes("NavigatorLockAcquireTimeoutError")||r.message.includes("lock")?i=l(c({},r),{message:"Error temporal del sistema. Intente nuevamente en unos segundos.",__isAuthError:!0}):i=l(c({},r),{message:r.message||"Error de autenticaci\xF3n",__isAuthError:!0})),{user:null,error:i}}return{user:s?.user||null,error:r}}))}signInWithRetry(t,e,s=3){return a(this,null,function*(){let r=0;for(;r<s;)try{let i=this.supabase.auth.signInWithPassword({email:t,password:e}),o=new Promise((b,y)=>setTimeout(()=>y(new Error("Login timeout - La conexi\xF3n tard\xF3 demasiado")),45e3)),u=yield Promise.race([i,o]);if(u.error&&u.error.message&&(u.error.message.includes("NavigatorLockAcquireTimeoutError")||u.error.message.includes("lock")||u.error.message.includes("timeout"))){yield this.clearAuthLocks();let b=Math.min(2e3*Math.pow(2,r),8e3);yield this.delay(b),r++;continue}return u}catch(i){if(i.message&&(i.message.includes("timeout")||i.message.includes("NavigatorLockAcquireTimeoutError")||i.message.includes("lock"))){yield this.clearAuthLocks();let o=Math.min(2e3*Math.pow(2,r),8e3);yield this.delay(o),r++;continue}return{data:null,error:i}}return{data:null,error:{message:"No se pudo conectar con el servidor. Verifique su conexi\xF3n a internet e intente nuevamente.",__isAuthError:!0,code:"MAX_RETRIES_EXCEEDED"}}})}findUserByEmail(t){return a(this,null,function*(){try{let{data:e,error:s}=yield this.supabase.db.from("users").select("*").eq("email",t).single();return s?null:e}catch{return null}})}signUp(t,e,s,r="logistica"){return m(this.supabase.auth.signUp({email:t,password:e,options:{emailRedirectTo:void 0}})).pipe(f(u=>a(this,[u],function*({data:i,error:o}){i.user&&!o&&(yield this.createUserProfile(i.user.id,t,s,r))})),d(({data:i,error:o})=>({user:i.user,error:o})))}createUserProfile(t,e,s,r){return a(this,null,function*(){try{let{error:i}=yield this.supabase.db.from("users").insert({id:t,email:e,nombre:s,rol:r});i||(yield this.loadUserProfile(t),yield this.assignDefaultObraToUser(t,r))}catch{}})}assignDefaultObraToUser(t,e){return a(this,null,function*(){try{console.log("\u{1F504} Asignando obra autom\xE1ticamente al usuario:",t);let{data:s,error:r}=yield this.supabase.db.from("obras").select("id").limit(1);if(r||!s||s.length===0){console.warn("\u26A0\uFE0F No hay obras disponibles para asignar");return}let i=s[0].id;console.log("\u{1F3D7}\uFE0F Asignando obra:",i,"al usuario:",t);let{error:o}=yield this.supabase.db.from("user_obras").insert({user_id:t,obra_id:i,rol_obra:e,assigned_at:new Date().toISOString()});o?console.error("\u274C Error al asignar obra autom\xE1ticamente:",o):console.log("\u2705 Obra asignada autom\xE1ticamente exitosamente")}catch(s){console.error("\u{1F4A5} Error en asignaci\xF3n autom\xE1tica de obra:",s)}})}createBasicProfile(t){return a(this,null,function*(){try{let e=this.getCurrentUser();if(!e)return;let{error:s}=yield this.supabase.db.from("users").insert({id:t,email:e.email||"usuario@ejemplo.com",nombre:e.email?.split("@")[0]||"Usuario",rol:"logistica"});s||(yield this.loadUserProfile(t))}catch{}})}forceAuthStateUpdate(){return a(this,null,function*(){try{let{data:{session:t},error:e}=yield this.supabase.auth.getSession();if(e)return;t?.user?(this.currentUserSubject.next(t.user),this.sessionSubject.next(t),yield this.loadUserProfile(t.user.id)):(this.currentUserSubject.next(null),this.currentProfileSubject.next(null),this.sessionSubject.next(null))}catch{}})}signOut(){return m(this.supabase.auth.signOut()).pipe(f(()=>{this.currentUserSubject.next(null),this.currentProfileSubject.next(null),this.sessionSubject.next(null)}),d(({error:t})=>({error:t})))}getCurrentUser(){return this.currentUserSubject.value}getCurrentProfile(){return this.currentProfileSubject.value}isResident(){return this.getCurrentProfile()?.rol==="residente"}isLogistics(){return this.getCurrentProfile()?.rol==="logistica"}updateProfile(t){let e=this.getCurrentUser()?.id;if(!e)throw new Error("No user logged in");return m(this.supabase.db.from("users").update(l(c({},t),{updated_at:new Date().toISOString()})).eq("id",e).select().single()).pipe(f(({data:s,error:r})=>{s&&!r&&this.currentProfileSubject.next(s)}))}resetPassword(t){return m(this.supabase.auth.resetPasswordForEmail(t)).pipe(d(({error:e})=>({error:e})))}delay(t){return new Promise(e=>setTimeout(e,t))}static{this.\u0275fac=function(e){return new(e||n)(S(k))}}static{this.\u0275prov=g({token:n,factory:n.\u0275fac,providedIn:"root"})}}return n})();export{L as a};
